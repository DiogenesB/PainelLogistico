<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expedição/Recebimento</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #3b82f6;
            --primary-gradient: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --dark-gray: #334155;
            --gray: #64748b;
            --gray-light: #94a3b8;
            --light: #f1f5f9;
            --white: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius: 12px;
            --radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            font-size: 14px;
            font-weight: 400;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .container > * {
            margin-bottom: 20px;
        }

        .container > *:last-child {
            margin-bottom: 0;
        }

        /* Header */
        .header {
            background: var(--white);
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-main {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            box-shadow: var(--shadow);
        }

        .logo-text h1 {
            font-size: 1.6rem;
            color: var(--dark);
            font-weight: 700;
            line-height: 1.2;
        }

        .logo-text .subtitle {
            color: var(--gray);
            font-size: 0.85rem;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .header-filial {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-filial .filial-name {
            font-weight: 600;
            color: var(--primary);
            background: var(--light);
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }

        .header-filial .filial-name.todas {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filial-selector {
            position: relative;
            min-width: 280px;
        }

        .filial-selector .select-primary {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--primary);
            border-radius: var(--radius-sm);
            background: var(--white);
            font-weight: 500;
            color: var(--dark);
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%232563eb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 16px;
            transition: var(--transition);
        }

        .filial-selector .select-primary:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Cards */
        .card {
            background: var(--white);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .card-header {
            background: var(--white);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2, .card-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-header h2 i, .card-header h3 i {
            color: var(--primary);
        }

        .card-body {
            padding: 20px;
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            color: var(--gray);
            gap: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--light);
            border-left: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error */
        .error-alert {
            background: #fef2f2;
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 16px 20px;
            border-radius: var(--radius-sm);
            margin: 16px 0;
            font-weight: 500;
            border-left: 4px solid var(--danger);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Indicador de atualização */
        .update-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--primary);
            margin-bottom: 16px;
            border: 1px solid var(--border);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .update-indicator i {
            animation: spin 1s linear infinite;
        }

        /* Botão de Refresh */
        .btn-refresh-subtle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border: none;
            border-radius: var(--radius-sm);
            background: transparent;
            color: var(--gray);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            padding: 0;
        }

        .btn-refresh-subtle:hover {
            background: var(--light);
            color: var(--primary);
            transform: rotate(15deg);
        }

        .btn-refresh-subtle:active {
            transform: scale(0.95);
        }

        .btn-refresh-subtle.pulse {
            animation: pulse-animation 1.5s infinite;
        }

        @keyframes pulse-animation {
            0% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(37, 99, 235, 0); }
            100% { box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); }
        }

        /* Badge de atualização */
        .refresh-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            animation: pulse-animation 2s infinite;
        }

        .refresh-badge.hidden {
            display: none;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            font-family: inherit;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: var(--white);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8 0%, #1e3a8a 100%);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark-gray);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--gray-light);
            color: var(--white);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: var(--white);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-icon {
            padding: 10px;
            border-radius: var(--radius-sm);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            border: 1px solid var(--border);
            color: var(--gray);
        }

        .btn-icon:hover {
            background: var(--primary);
            color: var(--white);
            transform: translateY(-2px);
        }

        /* Forms */
        .input-field, .select-field {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 14px;
            transition: var(--transition);
            background: var(--white);
            font-family: inherit;
            color: var(--dark);
            height: 44px;
        }

        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Estilos para filtros com botão de limpar */
        .filter-group {
            position: relative;
            margin-bottom: 16px;
        }

        .filter-clear {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--gray-light);
            cursor: pointer;
            font-size: 1.2rem;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
            z-index: 10;
        }

        .filter-clear:hover {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Estilos específicos para inputs de data */
        .input-field[type="date"] {
            color: var(--dark);
            position: relative;
        }

        .input-field[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            opacity: 0.6;
            transition: var(--transition);
            padding: 5px;
            background-size: 16px;
        }

        .input-field[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }

        /* Placeholder personalizado para inputs vazios */
        .input-field[type="date"]:not(:valid):not(:focus)::before {
            content: attr(placeholder);
            color: var(--gray-light);
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            background: white;
            padding: 0 4px;
        }

        /* Remover o placeholder quando em foco ou com valor */
        .input-field[type="date"]:focus::before,
        .input-field[type="date"]:valid::before {
            content: "";
        }

        /* CORREÇÃO COMPLETA DOS FILTROS DE DATA */
        .filter-group.date-range {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
            width: 100%;
        }

        .filter-group.date-range .date-range-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }

        .filter-group.date-range .date-inputs-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
        }

        .filter-group.date-range .date-input-wrapper {
            position: relative;
            width: 100%;
        }

        .filter-group.date-range .date-input-wrapper .input-field[type="date"] {
            padding-right: 35px;
            width: 100%;
            height: 44px;
        }

        .filter-group.date-range .date-input-wrapper .filter-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--gray-light);
            cursor: pointer;
            font-size: 1.2rem;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
            z-index: 10;
        }

        .filter-group.date-range .date-input-wrapper .filter-clear:hover {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .filter-group.date-range label {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--dark-gray);
            font-weight: 600;
            width: 100%;
        }

        .filter-group.date-range .date-hint {
            font-size: 0.7rem;
            color: var(--gray-light);
            font-style: italic;
            margin-top: 4px;
            width: 100%;
        }

        /* Ajuste específico para filtros em grid */
        .filters-grid .filter-group.date-range {
            grid-column: span 2;
        }

        /* Autocomplete */
        .autocomplete-container {
            position: relative;
        }

        .autocomplete-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--white);
            border: 1px solid var(--border);
            border-top: none;
            border-radius: 0 0 var(--radius-sm) var(--radius-sm);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            display: none;
        }

        .autocomplete-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .autocomplete-item:hover {
            background: var(--light);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        /* Filters */
        .filters-section {
            margin-bottom: 20px;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: start;
        }

        .filter-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
            width: 100%;
        }

        .filter-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .filter-hint {
            font-size: 0.75rem;
            color: var(--gray-light);
            margin-top: 4px;
            display: block;
            line-height: 1.3;
        }

        /* KPIs - COMPACTADO */
        .kpis-section {
            margin-bottom: 20px;
        }

        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
        }

        .kpi-card {
            background: var(--white);
            padding: 18px 16px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: var(--transition);
            border-left: 4px solid var(--primary);
            position: relative;
            overflow: hidden;
            height: 100%;
            min-height: 140px;
            justify-content: center;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .kpi-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            border-radius: var(--radius);
            color: var(--primary);
            font-size: 1.3rem;
            box-shadow: var(--shadow);
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .kpi-content {
            flex: 1;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .kpi-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 6px;
            line-height: 1.2;
            cursor: help;
            position: relative;
            text-align: center;
            width: 100%;
            word-break: break-word;
        }

        .kpi-label {
            color: var(--gray);
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: center;
            width: 100%;
            line-height: 1.2;
        }

        /* Cores para tipos de carregamento nos KPIs */
        .kpi-card[data-tipo="fracionado"] {
            border-left-color: #3b82f6;
        }

        .kpi-card[data-tipo="dedicado"] {
            border-left-color: #10b981;
        }

        .kpi-card[data-tipo="retira"] {
            border-left-color: #f59e0b;
        }

        .kpi-card[data-tipo="fracionado"]::before {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .kpi-card[data-tipo="dedicado"]::before {
            background: linear-gradient(135deg, #10b981 0%, #047857 100%);
        }

        .kpi-card[data-tipo="retira"]::before {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        /* Estilo para tooltip do KPI */
        .kpi-value[title] {
            cursor: help;
            position: relative;
        }

        .kpi-value[title]:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: pre-line;
            z-index: 1000;
            margin-bottom: 8px;
            box-shadow: var(--shadow-lg);
            min-width: 180px;
            text-align: center;
            font-weight: normal;
        }

        .kpi-value[title]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-top-color: var(--dark);
            margin-bottom: 3px;
        }

        /* Tabs */
        .tabs-section {
            margin-top: 20px;
        }

        .tabs {
            display: flex;
            background: var(--white);
            border-radius: var(--radius);
            padding: 6px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            gap: 4px;
            border: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--gray);
            font-weight: 600;
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .tab-btn:hover {
            background: var(--light);
            color: var(--dark);
        }

        .tab-btn.active {
            background: var(--primary-gradient);
            color: var(--white);
            box-shadow: var(--shadow);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Tables - COMPACTADO */
        .table-container {
            overflow-x: auto;
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid var(--border);
            margin-top: 0;
            margin-bottom: 0;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--white);
            font-size: 0.8rem;
            min-width: 1400px;
        }

        .data-table th {
            background: var(--dark-gray);
            color: var(--white);
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid var(--dark);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 5;
        }

        .data-table td {
            padding: 8px 6px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
            color: var(--dark-gray);
        }

        .data-table tr:hover {
            background: var(--light);
        }

        .data-table tr.error-row {
            background: #fef2f2;
            border-left: 4px solid var(--danger);
        }

        .data-table tr.error-row:hover {
            background: #fecaca;
        }

        /* MODIFICAÇÃO: Cores mais suaves para atrasos */
        .data-table tr.atraso-transportadora {
            background: #fff7ed;
            border-left: 4px solid #fbbf24;
        }

        .data-table tr.atraso-transportadora:hover {
            background: #fed7aa;
        }

        .data-table tr.atraso-expedicao {
            background: #fef2f2;
            border-left: 4px solid #fca5a5;
        }

        .data-table tr.atraso-expedicao:hover {
            background: #fecaca;
        }

        .card-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            position: relative;
            cursor: help;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-em-separacao {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
        }

        .status-falta-separacao {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .status-separado {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        /* MODIFICAÇÃO: Cores mais suaves para status de atraso */
        .status-atraso-transportadora {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
            color: #7c2d12;
        }

        .status-atraso-expedicao {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
            color: #7f1d1d;
        }

        .status-no-prazo {
            background: linear-gradient(135deg, #a7f3d0 0%, #6ee7b7 100%);
            color: #064e3b;
        }

        .status-sem-dados {
            background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
            color: #1e293b;
        }

        /* Tooltip para status */
        .status-badge:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--dark);
            color: white;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            white-space: pre-line;
            z-index: 1000;
            margin-bottom: 5px;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            max-width: 300px;
            text-align: center;
        }

        .status-badge:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: var(--dark);
            margin-bottom: -5px;
        }

        /* Indicador de dados em cache */
        .cache-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: var(--radius-sm);
            font-size: 0.8rem;
            color: var(--primary);
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }

        .cache-indicator .cache-icon {
            color: var(--primary);
            font-size: 0.9rem;
        }

        /* Novos estilos para filtros melhorados */
        .advanced-filters {
            margin-top: 16px;
            padding: 16px;
            background: var(--light);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            grid-column: 1 / -1;
        }

        .advanced-filters-header {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .advanced-filters-header h4 {
            color: var(--dark);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .advanced-filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .filter-results {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--dark);
            background: linear-gradient(135deg, var(--light) 0%, #e2e8f0 100%);
            border: 1px solid var(--border);
            padding: 10px;
            border-radius: var(--radius-sm);
            margin-top: 12px;
            grid-column: 1 / -1;
        }

        .filter-results i {
            color: var(--primary);
        }

        #resultsCount {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }

        /* Melhorias para inputs numéricos */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
            height: 24px;
        }

        /* Validação visual para filtros */
        .input-field:invalid,
        .select-field:invalid {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .input-field:valid:focus,
        .select-field:valid:focus {
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Validação visual para datas */
        .input-field[type="date"]:invalid {
            border-color: var(--danger);
            background: #fef2f2;
        }

        .input-field[type="date"]:valid {
            border-color: var(--success);
        }

        /* MODIFICAÇÃO: Paginação em cima da tabela */
        .table-pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--white);
            border-bottom: 1px solid var(--border);
            border-radius: var(--radius) var(--radius) 0 0;
            margin-bottom: 0;
            flex-wrap: wrap;
            gap: 8px;
        }

        .table-pagination-container.bottom {
            border-top: 1px solid var(--border);
            border-bottom: none;
            border-radius: 0 0 var(--radius) var(--radius);
            margin-top: 0;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .pagination-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .pagination-info {
            color: var(--gray);
            font-size: 0.85rem;
            min-width: 180px;
        }

        .page-input {
            width: 60px;
            padding: 6px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .page-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Botões de navegação desabilitados */
        .btn-icon:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-icon:disabled:hover {
            background: var(--light);
            color: var(--gray);
            transform: none;
            box-shadow: none;
        }

        /* Botão para limpar filtro individual */
        .filter-clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: transparent;
            border: none;
            color: var(--gray-light);
            cursor: pointer;
            font-size: 1.2rem;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
            z-index: 10;
        }

        .filter-clear-btn:hover {
            color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .container {
                padding: 20px;
            }
            
            .filters-grid {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 16px;
            }
            
            .kpis-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
                gap: 10px;
            }
            
            .kpi-card {
                padding: 16px 14px;
                min-height: 130px;
            }
            
            .kpi-icon {
                width: 44px;
                height: 44px;
                font-size: 1.2rem;
                margin-bottom: 10px;
            }
            
            .kpi-value {
                font-size: 1.4rem;
            }
            
            .kpi-label {
                font-size: 0.75rem;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 16px;
                text-align: center;
            }
            
            .header-main {
                flex-direction: column;
                gap: 10px;
            }
            
            .filial-selector {
                min-width: 100%;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .filter-group.date-range .date-inputs-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .filters-grid .filter-group.date-range {
                grid-column: span 1;
            }
            
            .kpis-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
            }
            
            .kpi-card {
                padding: 14px 12px;
                min-height: 120px;
            }
            
            .kpi-icon {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
                margin-bottom: 8px;
            }
            
            .kpi-value {
                font-size: 1.3rem;
                margin-bottom: 4px;
            }
            
            .kpi-label {
                font-size: 0.7rem;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .data-table {
                font-size: 0.75rem;
                min-width: 1000px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 6px;
            }
            
            .filter-actions {
                flex-direction: column;
            }
            
            .table-pagination-container {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .pagination-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .pagination-buttons {
                justify-content: center;
            }
            
            .card-body {
                padding: 16px;
            }
            
            .btn-refresh-subtle {
                position: static;
                margin-left: auto;
            }
        }

        @media (max-width: 576px) {
            .kpis-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .kpi-card {
                padding: 12px 10px;
                min-height: 110px;
            }
            
            .kpi-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
                margin-bottom: 6px;
            }
            
            .kpi-value {
                font-size: 1.2rem;
                margin-bottom: 3px;
            }
            
            .kpi-label {
                font-size: 0.65rem;
            }
            
            .btn {
                padding: 8px 16px;
                font-size: 13px;
            }
            
            .logo-text h1 {
                font-size: 1.4rem;
            }
            
            .tab-btn {
                padding: 10px 14px;
            }
        }

        @media (max-width: 400px) {
            .kpis-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .kpi-card {
                min-height: 100px;
                flex-direction: row;
                align-items: center;
                text-align: left;
                padding: 14px;
            }
            
            .kpi-icon {
                margin-bottom: 0;
                margin-right: 12px;
                width: 32px;
                height: 32px;
            }
            
            .kpi-content {
                align-items: flex-start;
                text-align: left;
            }
            
            .kpi-value {
                font-size: 1.1rem;
                text-align: left;
            }
            
            .kpi-label {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-main">
                    <div class="logo">
                        <div class="logo-icon">
                            <i class="fas fa-shipping-fast"></i>
                        </div>
                        <div class="logo-text">
                            <h1>Análise Expedição/Recebimento</h1>
                            <span class="subtitle">Análise Logística</span>
                        </div>
                    </div>
                    <button id="refreshData" class="btn-refresh-subtle" title="Atualizar dados manualmente">
                        <i class="fas fa-sync-alt"></i>
                        <div class="refresh-badge hidden" id="refreshBadge"></div>
                    </button>
                    <div class="header-filial">
                        <span class="filial-name" id="currentFilialName">Nenhuma filial selecionada</span>
                    </div>
                </div>
                
                <div class="header-actions">
                    <div class="filial-selector">
                        <select id="filialSelect" class="select-primary">
                            <option value="">Selecione uma filial</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- Indicador de Dados Locais (Cache) -->
        <div class="cache-indicator" id="cacheIndicator" style="display: none;">
            <i class="fas fa-database cache-icon"></i>
            <span>Usando dados locais. Próxima atualização em: <span id="nextUpdateTime">--:--</span></span>
        </div>

        <!-- Indicador de Atualização -->
        <div class="update-indicator" id="updateIndicator" style="display: none;">
            <i class="fas fa-sync-alt"></i>
            <span>Atualizando dados...</span>
        </div>

        <!-- KPIs Dinâmicos -->
        <section class="kpis-section">
            <!-- KPIs Expedição -->
            <div class="kpis-grid" id="kpisExpedicao">
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalPedidos">0</div>
                        <div class="kpi-label">Total de Pedidos</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="taxaErroExpedicao">0%</div>
                        <div class="kpi-label">Taxa de Erro Expedição</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="tempoMedioSeparacao">0h 00min</div>
                        <div class="kpi-label">Tempo Médio Separação</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="tempoMedioExpedicao">0h 00min</div>
                        <div class="kpi-label">Tempo Médio Carregamento</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-hourglass"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="leadTimeMedio">0h 00min</div>
                        <div class="kpi-label">Lead Time Médio</div>
                    </div>
                </div>
                <!-- NOVO KPI: Média Hora OC Enviada -->
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="mediaHoraOCEnviada">--:--</div>
                        <div class="kpi-label">Média Hora OC Enviada</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-pallet"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalPaletes">0</div>
                        <div class="kpi-label">Total de Paletes</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-truck-loading"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="atrasosTransportadora">0</div>
                        <div class="kpi-label">Atrasos Transportadora</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-warehouse"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="atrasosExpedicao">0</div>
                        <div class="kpi-label">Atrasos Expedição</div>
                    </div>
                </div>
                <!-- NOVOS KPIs PARA TIPO DE CARREGAMENTO -->
                <div class="kpi-card" data-tipo="fracionado">
                    <div class="kpi-icon" style="background: #dbeafe; color: #1e40af;">
                        <i class="fas fa-box-open"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="tipoFracionado">0</div>
                        <div class="kpi-label">Fracionado</div>
                    </div>
                </div>
                <div class="kpi-card" data-tipo="dedicado">
                    <div class="kpi-icon" style="background: #d1fae5; color: #065f46;">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="tipoDedicado">0</div>
                        <div class="kpi-label">Dedicado</div>
                    </div>
                </div>
                <div class="kpi-card" data-tipo="retira">
                    <div class="kpi-icon" style="background: #fef3c7; color: #92400e;">
                        <i class="fas fa-hand-paper"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="tipoRetira">0</div>
                        <div class="kpi-label">Retira</div>
                    </div>
                </div>
            </div>

            <!-- KPIs Recebimento -->
            <div class="kpis-grid" id="kpisRecebimento" style="display: none;">
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalNotas">0</div>
                        <div class="kpi-label">Total de Notas</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="notasLancadas">0</div>
                        <div class="kpi-label">Notas Lançadas</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="notasPendentes">0</div>
                        <div class="kpi-label">Notas Pendentes</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="taxaErroRecebimento">0%</div>
                        <div class="kpi-label">Taxa de Erro Receb.</div>
                    </div>
                </div>
            </div>

            <!-- KPIs Em Andamento -->
            <div class="kpis-grid" id="kpisEmAndamento" style="display: none;">
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="totalAndamento">0</div>
                        <div class="kpi-label">Pedidos em Andamento</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon">
                        <i class="fas fa-pallet"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="paletesAndamento">0</div>
                        <div class="kpi-label">Paletes em Andamento</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #fef3c7; color: #92400e;">
                        <i class="fas fa-hourglass-half"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="emSeparacaoCount">0</div>
                        <div class="kpi-label">Em Separação</div>
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-icon" style="background: #fee2e2; color: #991b1b;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="kpi-content">
                        <div class="kpi-value" id="faltaSeparacaoCount">0</div>
                        <div class="kpi-label">Falta Separação</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Filtros Específicos por Aba -->
        <section class="filters-section card">
            <div class="card-header">
                <h2><i class="fas fa-filter"></i> <span id="filtersTitle">Filtros de Expedição</span></h2>
                <div class="filter-actions">
                    <button id="applyFilters" class="btn btn-primary">
                        <i class="fas fa-check"></i>
                        <span>Aplicar Filtros</span>
                    </button>
                    <button id="resetFilters" class="btn btn-secondary">
                        <i class="fas fa-undo"></i>
                        <span>Limpar Todos</span>
                    </button>
                    <button id="toggleAdvancedFilters" class="btn btn-icon" title="Filtros avançados">
                        <i class="fas fa-sliders-h"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filtros Expedição -->
                <div class="filters-grid" id="filtersExpedicao">
                    <div class="filter-group">
                        <label for="numeroPedido"><i class="fas fa-hashtag"></i> Número do Pedido</label>
                        <div style="position: relative;">
                            <input type="text" id="numeroPedido" class="input-field" placeholder="Ex: 12345, 67890" pattern="[0-9,]*">
                            <button class="filter-clear-btn" data-for="numeroPedido" title="Limpar este filtro">×</button>
                        </div>
                        <small class="filter-hint">Separe múltiplos pedidos por vírgula</small>
                    </div>
                    <div class="filter-group">
                        <label for="clienteExpedicao"><i class="fas fa-user"></i> Cliente</label>
                        <div style="position: relative;">
                            <input type="text" id="clienteExpedicao" class="input-field" placeholder="Digite o cliente">
                            <button class="filter-clear-btn" data-for="clienteExpedicao" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="transportadoraExpedicao"><i class="fas fa-truck"></i> Transportadora</label>
                        <div style="position: relative;">
                            <select id="transportadoraExpedicao" class="select-field">
                                <option value="">Todas</option>
                            </select>
                            <button class="filter-clear-btn" data-for="transportadoraExpedicao" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="ufExpedicao"><i class="fas fa-map-marker-alt"></i> UF</label>
                        <div style="position: relative;">
                            <select id="ufExpedicao" class="select-field">
                                <option value="">Todas</option>
                            </select>
                            <button class="filter-clear-btn" data-for="ufExpedicao" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    
                    <!-- DATA CARREGAMENTO - CORRIGIDO -->
                    <div class="filter-group date-range">
                        <label for="dataCarregamentoInicio"><i class="fas fa-calendar-alt"></i> Data Carregamento</label>
                        <div class="date-range-container">
                            <div class="date-inputs-row">
                                <div class="date-input-wrapper">
                                    <input type="date" id="dataCarregamentoInicio" class="input-field" placeholder="Data inicial" title="Formato: dd/mm/aaaa">
                                    <button class="filter-clear-btn" data-for="dataCarregamentoInicio" title="Limpar este filtro">×</button>
                                </div>
                                <div class="date-input-wrapper">
                                    <input type="date" id="dataCarregamentoFim" class="input-field" placeholder="Data final" title="Formato: dd/mm/aaaa">
                                    <button class="filter-clear-btn" data-for="dataCarregamentoFim" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <small class="date-hint">Filtra pela data de carregamento (dd/mm/aaaa)</small>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="statusErroExpedicao"><i class="fas fa-exclamation-triangle"></i> Status de Erro</label>
                        <div style="position: relative;">
                            <select id="statusErroExpedicao" class="select-field">
                                <option value="">Todos</option>
                                <option value="com_erro">Com Erro</option>
                                <option value="sem_erro">Sem Erro</option>
                            </select>
                            <button class="filter-clear-btn" data-for="statusErroExpedicao" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="tipoErroExpedicao"><i class="fas fa-bug"></i> Tipo de Erro</label>
                        <div style="position: relative;">
                            <select id="tipoErroExpedicao" class="select-field">
                                <option value="">Todos</option>
                            </select>
                            <button class="filter-clear-btn" data-for="tipoErroExpedicao" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="statusAtrasoExpedicao"><i class="fas fa-clock"></i> Status Atraso</label>
                        <div style="position: relative;">
                            <select id="statusAtrasoExpedicao" class="select-field">
                                <option value="">Todos</option>
                                <option value="atraso_transportadora">Atraso Transportadora</option>
                                <option value="atraso_expedicao">Atraso Expedição</option>
                                <option value="no_prazo">No Prazo</option>
                                <option value="sem_dados">Sem Dados</option>
                            </select>
                            <button class="filter-clear-btn" data-for="statusAtrasoExpedicao" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    
                    <!-- NOVO FILTRO: Tipo de Carregamento - CORRIGIDO -->
                    <div class="filter-group">
                        <label for="tipoCarregamentoExpedicao"><i class="fas fa-shipping-fast"></i> Tipo de Carregamento</label>
                        <div style="position: relative;">
                            <select id="tipoCarregamentoExpedicao" class="select-field">
                                <option value="">Todos</option>
                                <option value="Fracionado">Fracionado</option>
                                <option value="Dedicado">Dedicado</option>
                                <option value="Retira">Retira</option>
                                <option value="">Sem Dados</option>
                            </select>
                            <button class="filter-clear-btn" data-for="tipoCarregamentoExpedicao" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    
                    <!-- Filtros avançados de expedição -->
                    <div class="advanced-filters" id="advancedFiltersExpedicao" style="display: none;">
                        <div class="advanced-filters-header">
                            <h4><i class="fas fa-cogs"></i> Filtros Avançados</h4>
                        </div>
                        <div class="advanced-filters-grid">
                            <div class="filter-group">
                                <label for="paletesMin"><i class="fas fa-pallet"></i> Paletes (Mín.)</label>
                                <div style="position: relative;">
                                    <input type="number" id="paletesMin" class="input-field" placeholder="Mínimo" min="0" step="0.1">
                                    <button class="filter-clear-btn" data-for="paletesMin" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="paletesMax"><i class="fas fa-pallet"></i> Paletes (Máx.)</label>
                                <div style="position: relative;">
                                    <input type="number" id="paletesMax" class="input-field" placeholder="Máximo" min="0" step="0.1">
                                    <button class="filter-clear-btn" data-for="paletesMax" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="leadTimeMin"><i class="fas fa-hourglass"></i> Lead Time Mín. (horas)</label>
                                <div style="position: relative;">
                                    <input type="number" id="leadTimeMin" class="input-field" placeholder="Mínimo" min="0" step="0.5">
                                    <button class="filter-clear-btn" data-for="leadTimeMin" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="leadTimeMax"><i class="fas fa-hourglass-end"></i> Lead Time Máx. (horas)</label>
                                <div style="position: relative;">
                                    <input type="number" id="leadTimeMax" class="input-field" placeholder="Máximo" min="0" step="0.5">
                                    <button class="filter-clear-btn" data-for="leadTimeMax" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="tempoSeparacaoMin"><i class="fas fa-clock"></i> Tempo Separação Mín. (horas)</label>
                                <div style="position: relative;">
                                    <input type="number" id="tempoSeparacaoMin" class="input-field" placeholder="Mínimo" min="0" step="0.5">
                                    <button class="filter-clear-btn" data-for="tempoSeparacaoMin" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="tempoSeparacaoMax"><i class="fas fa-clock"></i> Tempo Separação Máx. (horas)</label>
                                <div style="position: relative;">
                                    <input type="number" id="tempoSeparacaoMax" class="input-field" placeholder="Máximo" min="0" step="0.5">
                                    <button class="filter-clear-btn" data-for="tempoSeparacaoMax" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="cidadeExpedicao"><i class="fas fa-city"></i> Cidade</label>
                                <div style="position: relative;">
                                    <select id="cidadeExpedicao" class="select-field">
                                        <option value="">Todas</option>
                                    </select>
                                    <button class="filter-clear-btn" data-for="cidadeExpedicao" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <div class="filter-group">
                                <label for="notaFiscalExpedicao"><i class="fas fa-file-invoice"></i> Nota Fiscal</label>
                                <div style="position: relative;">
                                    <input type="text" id="notaFiscalExpedicao" class="input-field" placeholder="Número da NF">
                                    <button class="filter-clear-btn" data-for="notaFiscalExpedicao" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtros Recebimento -->
                <div class="filters-grid" id="filtersRecebimento" style="display: none;">
                    <div class="filter-group">
                        <label for="numeroNota"><i class="fas fa-hashtag"></i> Número da Nota</label>
                        <div style="position: relative;">
                            <input type="text" id="numeroNota" class="input-field" placeholder="Ex: 12345, 67890" pattern="[0-9,]*">
                            <button class="filter-clear-btn" data-for="numeroNota" title="Limpar este filtro">×</button>
                        </div>
                        <small class="filter-hint">Separe múltiplas notas por vírgula</small>
                    </div>
                    <div class="filter-group">
                        <label for="clienteRecebimento"><i class="fas fa-user"></i> Cliente/Filial</label>
                        <div style="position: relative;">
                            <input type="text" id="clienteRecebimento" class="input-field" placeholder="Digite cliente/filial">
                            <button class="filter-clear-btn" data-for="clienteRecebimento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="transportadoraRecebimento"><i class="fas fa-truck"></i> Transportadora</label>
                        <div style="position: relative;">
                            <select id="transportadoraRecebimento" class="select-field">
                                <option value="">Todas</option>
                            </select>
                            <button class="filter-clear-btn" data-for="transportadoraRecebimento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    
                    <!-- DATA RECEBIMENTO - CORRIGIDO -->
                    <div class="filter-group date-range">
                        <label for="dataRecebimentoInicio"><i class="fas fa-calendar-alt"></i> Data Recebimento</label>
                        <div class="date-range-container">
                            <div class="date-inputs-row">
                                <div class="date-input-wrapper">
                                    <input type="date" id="dataRecebimentoInicio" class="input-field" placeholder="Data inicial" title="Formato: dd/mm/aaaa">
                                    <button class="filter-clear-btn" data-for="dataRecebimentoInicio" title="Limpar este filtro">×</button>
                                </div>
                                <div class="date-input-wrapper">
                                    <input type="date" id="dataRecebimentoFim" class="input-field" placeholder="Data final" title="Formato: dd/mm/aaaa">
                                    <button class="filter-clear-btn" data-for="dataRecebimentoFim" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <small class="date-hint">Filtra pela data de recebimento (dd/mm/aaaa)</small>
                        </div>
                    </div>
                    
                    <!-- DATA LANÇAMENTO - CORRIGIDO -->
                    <div class="filter-group date-range">
                        <label for="dataLancamentoInicio"><i class="fas fa-calendar-alt"></i> Data Lançamento</label>
                        <div class="date-range-container">
                            <div class="date-inputs-row">
                                <div class="date-input-wrapper">
                                    <input type="date" id="dataLancamentoInicio" class="input-field" placeholder="Data inicial" title="Formato: dd/mm/aaaa">
                                    <button class="filter-clear-btn" data-for="dataLancamentoInicio" title="Limpar este filtro">×</button>
                                </div>
                                <div class="date-input-wrapper">
                                    <input type="date" id="dataLancamentoFim" class="input-field" placeholder="Data final" title="Formato: dd/mm/aaaa">
                                    <button class="filter-clear-btn" data-for="dataLancamentoFim" title="Limpar este filtro">×</button>
                                </div>
                            </div>
                            <small class="date-hint">Filtra pela data de lançamento (dd/mm/aaaa)</small>
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label for="armazemRecebimento"><i class="fas fa-warehouse"></i> Armazém</label>
                        <div style="position: relative;">
                            <select id="armazemRecebimento" class="select-field">
                                <option value="">Todos</option>
                            </select>
                            <button class="filter-clear-btn" data-for="armazemRecebimento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="statusLancamento"><i class="fas fa-tasks"></i> Status Lançamento</label>
                        <div style="position: relative;">
                            <select id="statusLancamento" class="select-field">
                                <option value="">Todos</option>
                                <option value="lancado">Lançados</option>
                                <option value="pendente">Pendentes</option>
                            </select>
                            <button class="filter-clear-btn" data-for="statusLancamento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="statusErroRecebimento"><i class="fas fa-exclamation-circle"></i> Status de Erro</label>
                        <div style="position: relative;">
                            <select id="statusErroRecebimento" class="select-field">
                                <option value="">Todos</option>
                                <option value="com_erro">Com Erro</option>
                                <option value="sem_erro">Sem Erro</option>
                            </select>
                            <button class="filter-clear-btn" data-for="statusErroRecebimento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                </div>

                <!-- Filtros Em Andamento -->
                <div class="filters-grid" id="filtersEmAndamento" style="display: none;">
                    <div class="filter-group">
                        <label for="pedidoAndamento"><i class="fas fa-hashtag"></i> Número do Pedido</label>
                        <div style="position: relative;">
                            <input type="text" id="pedidoAndamento" class="input-field" placeholder="Ex: 12345, 67890" pattern="[0-9,]*">
                            <button class="filter-clear-btn" data-for="pedidoAndamento" title="Limpar este filtro">×</button>
                        </div>
                        <small class="filter-hint">Separe múltiplos pedidos por vírgula</small>
                    </div>
                    <div class="filter-group">
                        <label for="clienteAndamento"><i class="fas fa-user"></i> Cliente</label>
                        <div style="position: relative;">
                            <input type="text" id="clienteAndamento" class="input-field" placeholder="Digite o cliente">
                            <button class="filter-clear-btn" data-for="clienteAndamento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="transportadoraAndamento"><i class="fas fa-truck"></i> Transportadora</label>
                        <div style="position: relative;">
                            <select id="transportadoraAndamento" class="select-field">
                                <option value="">Todas</option>
                            </select>
                            <button class="filter-clear-btn" data-for="transportadoraAndamento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="ufAndamento"><i class="fas fa-map-marker-alt"></i> UF</label>
                        <div style="position: relative;">
                            <select id="ufAndamento" class="select-field">
                                <option value="">Todas</option>
                            </select>
                            <button class="filter-clear-btn" data-for="ufAndamento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="cidadeAndamento"><i class="fas fa-city"></i> Cidade</label>
                        <div style="position: relative;">
                            <select id="cidadeAndamento" class="select-field">
                                <option value="">Todas</option>
                            </select>
                            <button class="filter-clear-btn" data-for="cidadeAndamento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <label for="statusSeparacao"><i class="fas fa-check-circle"></i> Status Separação</label>
                        <div style="position: relative;">
                            <select id="statusSeparacao" class="select-field">
                                <option value="">Todos</option>
                                <option value="em_separacao">Em Separação</option>
                                <option value="falta_separacao">Falta Separação</option>
                                <option value="separado">Separado</option>
                            </select>
                            <button class="filter-clear-btn" data-for="statusSeparacao" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                    <!-- NOVO FILTRO: Tipo de Carregamento (Em Andamento) - CORRIGIDO -->
                    <div class="filter-group">
                        <label for="tipoCarregamentoAndamento"><i class="fas fa-shipping-fast"></i> Tipo de Carregamento</label>
                        <div style="position: relative;">
                            <select id="tipoCarregamentoAndamento" class="select-field">
                                <option value="">Todos</option>
                                <option value="Fracionado">Fracionado</option>
                                <option value="Dedicado">Dedicado</option>
                                <option value="Retira">Retira</option>
                                <option value="">Sem Dados</option>
                            </select>
                            <button class="filter-clear-btn" data-for="tipoCarregamentoAndamento" title="Limpar este filtro">×</button>
                        </div>
                    </div>
                </div>
                
                <!-- Contador de resultados -->
                <div class="filter-results" id="filterResults" style="display: none;">
                    <i class="fas fa-chart-bar"></i>
                    <span id="resultsCount">0</span> resultados encontrados
                </div>
            </div>
        </section>

        <!-- Tabs -->
        <section class="tabs-section">
            <div class="tabs">
                <button class="tab-btn active" data-tab="expedicao">
                    <i class="fas fa-shipping-fast"></i>
                    Expedição
                </button>
                <button class="tab-btn" data-tab="recebimento">
                    <i class="fas fa-dolly"></i>
                    Recebimento
                </button>
                <button class="tab-btn" data-tab="emandamento">
                    <i class="fas fa-clock"></i>
                    Em Andamento
                </button>
            </div>

            <!-- Conteúdo Expedição -->
            <div class="tab-content active" id="expedicao-content">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-table"></i> Dados de Expedição</h3>
                        <div class="card-actions">
                            <button id="exportExpedicao" class="btn btn-success">
                                <i class="fas fa-file-export"></i>
                                <span>Exportar CSV</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="loading" id="loadingExpedicao">
                            <div class="spinner"></div>
                            <span>Carregando dados de expedição...</span>
                        </div>
                        <div class="error-alert" id="errorExpedicao" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="errorTextExpedicao"></span>
                        </div>
                        
                        <!-- MODIFICAÇÃO: Paginação em cima da tabela -->
                        <div class="table-pagination-container" id="pagination-top-expedicao" style="display: none;">
                            <div class="pagination-info" style="color: var(--gray); font-size: 0.9rem;">
                                Mostrando <span id="start-top-expedicao">0</span>-<span id="end-top-expedicao">0</span> de <span id="total-top-expedicao">0</span> registros
                            </div>
                            <div class="pagination-controls" style="display: flex; align-items: center; gap: 8px;">
                                <select id="itemsPerPage-top-expedicao" class="select-field" style="width: auto; padding: 6px 10px; font-size: 0.9rem;">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span style="color: var(--gray);">por página</span>
                                <div class="pagination-buttons" style="display: flex; gap: 4px;">
                                    <button class="btn btn-icon first-page-top" title="Primeira página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button class="btn btn-icon prev-page-top" title="Página anterior" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <span style="padding: 6px 12px; color: var(--dark); font-weight: 500;">
                                        Página <input type="number" id="currentPage-top-expedicao" value="1" min="1" style="width: 50px; padding: 2px; text-align: center; border: 1px solid var(--border); border-radius: 4px;"> de <span id="totalPages-top-expedicao">1</span>
                                    </span>
                                    <button class="btn btn-icon next-page-top" title="Próxima página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button class="btn btn-icon last-page-top" title="Última página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table id="tabelaExpedicao" class="data-table" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Filial</th>
                                        <th>Pedido</th>
                                        <th>Cliente</th>
                                        <th>Cidade</th>
                                        <th>UF</th>
                                        <th>Paletes</th>
                                        <th>Nota Fiscal</th>
                                        <th>Data Empenho</th>
                                        <th>Data OC Enviada</th>
                                        <th>Chegada Transp.</th>
                                        <th>Data Carregamento</th>
                                        <th>Tempo Separação</th>
                                        <th>Tempo Carregamento</th>
                                        <th>Transportadora</th>
                                        <th>Tipo Carregamento</th>
                                        <th>Hora Programada</th>
                                        <th>Lead Time</th>
                                        <th>Status Atraso</th>
                                        <th>Status Erro</th>
                                        <th>Erro</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyExpedicao"></tbody>
                            </table>
                        </div>
                        
                        <!-- MODIFICAÇÃO: Paginação em baixo mantida -->
                        <div class="table-pagination-container bottom" id="pagination-bottom-expedicao" style="display: none;">
                            <div class="pagination-info" style="color: var(--gray); font-size: 0.9rem;">
                                Mostrando <span id="start-bottom-expedicao">0</span>-<span id="end-bottom-expedicao">0</span> de <span id="total-bottom-expedicao">0</span> registros
                            </div>
                            <div class="pagination-controls" style="display: flex; align-items: center; gap: 8px;">
                                <select id="itemsPerPage-bottom-expedicao" class="select-field" style="width: auto; padding: 6px 10px; font-size: 0.9rem;">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span style="color: var(--gray);">por página</span>
                                <div class="pagination-buttons" style="display: flex; gap: 4px;">
                                    <button class="btn btn-icon first-page-bottom" title="Primeira página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button class="btn btn-icon prev-page-bottom" title="Página anterior" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <span style="padding: 6px 12px; color: var(--dark); font-weight: 500;">
                                        Página <input type="number" id="currentPage-bottom-expedicao" value="1" min="1" style="width: 50px; padding: 2px; text-align: center; border: 1px solid var(--border); border-radius: 4px;"> de <span id="totalPages-bottom-expedicao">1</span>
                                    </span>
                                    <button class="btn btn-icon next-page-bottom" title="Próxima página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button class="btn btn-icon last-page-bottom" title="Última página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conteúdo Recebimento -->
            <div class="tab-content" id="recebimento-content">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-table"></i> Dados de Recebimento</h3>
                        <div class="card-actions">
                            <button id="exportRecebimento" class="btn btn-success">
                                <i class="fas fa-file-export"></i>
                                <span>Exportar CSV</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="loading" id="loadingRecebimento">
                            <div class="spinner"></div>
                            <span>Carregando dados de recebimento...</span>
                        </div>
                        <div class="error-alert" id="errorRecebimento" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="errorTextRecebimento"></span>
                        </div>
                        
                        <!-- MODIFICAÇÃO: Paginação em cima da tabela -->
                        <div class="table-pagination-container" id="pagination-top-recebimento" style="display: none;">
                            <div class="pagination-info" style="color: var(--gray); font-size: 0.9rem;">
                                Mostrando <span id="start-top-recebimento">0</span>-<span id="end-top-recebimento">0</span> de <span id="total-top-recebimento">0</span> registros
                            </div>
                            <div class="pagination-controls" style="display: flex; align-items: center; gap: 8px;">
                                <select id="itemsPerPage-top-recebimento" class="select-field" style="width: auto; padding: 6px 10px; font-size: 0.9rem;">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50"selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span style="color: var(--gray);">por página</span>
                                <div class="pagination-buttons" style="display: flex; gap: 4px;">
                                    <button class="btn btn-icon first-page-top" title="Primeira página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button class="btn btn-icon prev-page-top" title="Página anterior" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <span style="padding: 6px 12px; color: var(--dark); font-weight: 500;">
                                        Página <input type="number" id="currentPage-top-recebimento" value="1" min="1" style="width: 50px; padding: 2px; text-align: center; border: 1px solid var(--border); border-radius: 4px;"> de <span id="totalPages-top-recebimento">1</span>
                                    </span>
                                    <button class="btn btn-icon next-page-top" title="Próxima página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button class="btn btn-icon last-page-top" title="Última página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table id="tabelaRecebimento" class="data-table" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Filial</th>
                                        <th>NF</th>
                                        <th>Cliente/Filial</th>
                                        <th>Transportadora</th>
                                        <th>Data Recebimento</th>
                                        <th>Data Lançamento</th>
                                        <th>Armazém</th>
                                        <th>Status</th>
                                        <th>Erro</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyRecebimento"></tbody>
                            </table>
                        </div>
                        
                        <!-- MODIFICAÇÃO: Paginação em baixo mantida -->
                        <div class="table-pagination-container bottom" id="pagination-bottom-recebimento" style="display: none;">
                            <div class="pagination-info" style="color: var(--gray); font-size: 0.9rem;">
                                Mostrando <span id="start-bottom-recebimento">0</span>-<span id="end-bottom-recebimento">0</span> de <span id="total-bottom-recebimento">0</span> registros
                            </div>
                            <div class="pagination-controls" style="display: flex; align-items: center; gap: 8px;">
                                <select id="itemsPerPage-bottom-recebimento" class="select-field" style="width: auto; padding: 6px 10px; font-size: 0.9rem;">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50"selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span style="color: var(--gray);">por página</span>
                                <div class="pagination-buttons" style="display: flex; gap: 4px;">
                                    <button class="btn btn-icon first-page-bottom" title="Primeira página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button class="btn btn-icon prev-page-bottom" title="Página anterior" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <span style="padding: 6px 12px; color: var(--dark); font-weight: 500;">
                                        Página <input type="number" id="currentPage-bottom-recebimento" value="1" min="1" style="width: 50px; padding: 2px; text-align: center; border: 1px solid var(--border); border-radius: 4px;"> de <span id="totalPages-bottom-recebimento">1</span>
                                    </span>
                                    <button class="btn btn-icon next-page-bottom" title="Próxima página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button class="btn btn-icon last-page-bottom" title="Última página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conteúdo Em Andamento -->
            <div class="tab-content" id="emandamento-content">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-table"></i> Dados Em Andamento</h3>
                        <div class="card-actions">
                            <button id="exportEmAndamento" class="btn btn-success">
                                <i class="fas fa-file-export"></i>
                                <span>Exportar CSV</span>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="loading" id="loadingEmAndamento">
                            <div class="spinner"></div>
                            <span>Carregando dados em andamento...</span>
                        </div>
                        <div class="error-alert" id="errorEmAndamento" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="errorTextEmAndamento"></span>
                        </div>
                        
                        <!-- MODIFICAÇÃO: Paginação em cima da tabela -->
                        <div class="table-pagination-container" id="pagination-top-emandamento" style="display: none;">
                            <div class="pagination-info" style="color: var(--gray); font-size: 0.9rem;">
                                Mostrando <span id="start-top-emandamento">0</span>-<span id="end-top-emandamento">0</span> de <span id="total-top-emandamento">0</span> registros
                            </div>
                            <div class="pagination-controls" style="display: flex; align-items: center; gap: 8px;">
                                <select id="itemsPerPage-top-emandamento" class="select-field" style="width: auto; padding: 6px 10px; font-size: 0.9rem;">
                                    <option value="10" selected>10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span style="color: var(--gray);">por página</span>
                                <div class="pagination-buttons" style="display: flex; gap: 4px;">
                                    <button class="btn btn-icon first-page-top" title="Primeira página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button class="btn btn-icon prev-page-top" title="Página anterior" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <span style="padding: 6px 12px; color: var(--dark); font-weight: 500;">
                                        Página <input type="number" id="currentPage-top-emandamento" value="1" min="1" style="width: 50px; padding: 2px; text-align: center; border: 1px solid var(--border); border-radius: 4px;"> de <span id="totalPages-top-emandamento">1</span>
                                    </span>
                                    <button class="btn btn-icon next-page-top" title="Próxima página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button class="btn btn-icon last-page-top" title="Última página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table id="tabelaEmAndamento" class="data-table" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Filial</th>
                                        <th>Pedido</th>
                                        <th>Cliente</th>
                                        <th>Cidade</th>
                                        <th>UF</th>
                                        <th>Paletes</th>
                                        <th>Nota Fiscal</th>
                                        <th>Transportadora</th>
                                        <th>Tipo Carregamento</th>
                                        <th>Status Separação</th>
                                    </tr>
                                </thead>
                                <tbody id="tbodyEmAndamento"></tbody>
                            </table>
                        </div>
                        
                        <!-- MODIFICAÇÃO: Paginação em baixo mantida -->
                        <div class="table-pagination-container bottom" id="pagination-bottom-emandamento" style="display: none;">
                            <div class="pagination-info" style="color: var(--gray); font-size: 0.9rem;">
                                Mostrando <span id="start-bottom-emandamento">0</span>-<span id="end-bottom-emandamento">0</span> de <span id="total-bottom-emandamento">0</span> registros
                            </div>
                            <div class="pagination-controls" style="display: flex; align-items: center; gap: 8px;">
                                <select id="itemsPerPage-bottom-emandamento" class="select-field" style="width: auto; padding: 6px 10px; font-size: 0.9rem;">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50" selected>50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                                <span style="color: var(--gray);">por página</span>
                                <div class="pagination-buttons" style="display: flex; gap: 4px;">
                                    <button class="btn btn-icon first-page-bottom" title="Primeira página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                    <button class="btn btn-icon prev-page-bottom" title="Página anterior" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                    <span style="padding: 6px 12px; color: var(--dark); font-weight: 500;">
                                        Página <input type="number" id="currentPage-bottom-emandamento" value="1" min="1" style="width: 50px; padding: 2px; text-align: center; border: 1px solid var(--border); border-radius: 4px;"> de <span id="totalPages-bottom-emandamento">1</span>
                                    </span>
                                    <button class="btn btn-icon next-page-bottom" title="Próxima página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                    <button class="btn btn-icon last-page-bottom" title="Última página" style="width: 40px; height: 40px;">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Configuração
        const CONFIG = {
            API_URL: 'https://script.google.com/macros/s/AKfycbzweabEfW5qdRki3DLYKSwhlod7M02Bj2xV80h6hsr50CzsVLKKkbHZ69sSvdweA72_Kw/exec',
            
            FILIAIS: [
                {id: '1VZDqj4wNs8SxkNX1zi_1LqipkaCjlD8tLPuD3aAwwUQ', nome: 'SIMBIOSE CRUZ ALTA' },
                {id: '1CWXFbZ4Caxr267fUpIdfuyHYqnBcodssLAYbH9F4GTg', nome: 'BALSA MA' },
                {id: '1LF7RtVYlyDMpkflJAuZCQDkhOSEg0pzG0CLfUJOEsnk', nome: 'BIOMA FAZENDA RIO GRANDE'},
                {id: '13p7Yw6Iir-rohvefGg4NKyh-wr0s824arFYwGOEF6zA', nome: 'PARAGOMINAS - DEMETER'},
                {id: '1HFz_dw5XdK6o_rigTsooBABY4jHSFTL4hvi9kZPIaX8', nome: 'SIMBIOSE CANARANA'},
                {id: '107t-Jwtrqe4w52YrJ8nOVOHTuNVcu2gyfYaPe-okXTA', nome: 'SIMBIOSE DOURADOS'},
                {id: '1xOsQMc8s5eBUL3Fb6RwXWn36mSlbda64FlBJMQv-H-0', nome: 'SIMBIOSE LUCAS RIO VERDE'},
                {id: '1xh9w29o9_zv3QuEKSv6bgz7N_orSsDR2KnVAT8z44p8', nome: 'SIMBIOSE PORTO NACIONAL'},
                {id: '1T0ucGLS7VaQLQIKveI8vxQGEDxbMbfSzJmrwp3y2byk', nome: 'SIMBIOSE UBERLANDIA'},
                {id: '10EFatNDYxEBTBVHCxwW4zC8sl7wMjZuK2p1p8BTIl6o', nome: 'SIMBIOSE VILHENA' },
                {id: '1ExveH-DJcITa6d54SbSCriLbLh_pzcrgVZ231akCeK8', nome: 'VARGINHA - FOCAL'},
                {id: '1V8qvwQjlGow91ob0lt6PFsZU5HbemRPbuEhwqlXb14U', nome: 'SINOP - HARMONICA' },
                {id: '1nWK3acdtFijw7W1j1Yi21TDC4H7KWalEnh4jg9MFeaE', nome: 'CAMPO MOURÃO - LINEUS'},
                {id: '1uFi0uLB4GKYhjBrfpQpn0HIm00TEYDq3qZ726ytyoJQ', nome: 'RIO VERDE - MILIUM'},
                {id: '11q1kf_T2p-Aq9XZjrgR6QNJAG7BYl1VLnPPFDWEXbZU', nome: 'AP. DE GOIANIA - MOVIX'},
                {id: '1kUOhk_yVJANR_HjScoaWkcjonNNl1gEb_lGB5JN_SEI', nome: 'SIMBIOSE RIBEIRÃO PRETO' },
                {id: '18h6-7ty8pYd-WZJzJQfYVwX9jKkLmNopT5vQqHqA3Q4', nome: 'SIMBIOSE LUIZ EDUARDO MAGALHÃES' },  
            ],
            
            CACHE_DURATION: 30 * 60 * 1000, // 30 minutos em milissegundos
            CACHE_KEY_PREFIX: 'dashboard_data_'
        };

        // Cache de dados melhorado (localStorage + memória)
        const dataCache = {
            expedicao: null,
            recebimento: null,
            emandamento: null,
            lastFetch: null,
            cacheExpiry: null,
            
            salvarNoLocalStorage(filialId, tipo, dados) {
                try {
                    const cacheKey = `${CONFIG.CACHE_KEY_PREFIX}${filialId}_${tipo}`;
                    const cacheData = {
                        dados: dados,
                        timestamp: Date.now(),
                        expiry: Date.now() + CONFIG.CACHE_DURATION
                    };
                    localStorage.setItem(cacheKey, JSON.stringify(cacheData));
                } catch (error) {
                    console.warn('Erro ao salvar no localStorage:', error);
                }
            },
            
            carregarDoLocalStorage(filialId, tipo) {
                try {
                    const cacheKey = `${CONFIG.CACHE_KEY_PREFIX}${filialId}_${tipo}`;
                    const cacheItem = localStorage.getItem(cacheKey);
                    
                    if (!cacheItem) return null;
                    
                    const cacheData = JSON.parse(cacheItem);
                    
                    // Verificar se o cache ainda é válido
                    if (Date.now() > cacheData.expiry) {
                        localStorage.removeItem(cacheKey);
                        return null;
                    }
                    
                    return cacheData.dados;
                } catch (error) {
                    console.warn('Erro ao carregar do localStorage:', error);
                    return null;
                }
            },
            
            limparCacheLocal(filialId) {
                try {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(`${CONFIG.CACHE_KEY_PREFIX}${filialId}_`)) {
                            localStorage.removeItem(key);
                        }
                    });
                } catch (error) {
                    console.warn('Erro ao limpar cache local:', error);
                }
            }
        };

        // Utilitários
        class Utils {
            static formatarData(data, formato = 'br') {
                if (!data) return '';
                try {
                    if (typeof data === 'string' && data.includes('T')) {
                        const date = new Date(data);
                        if (isNaN(date.getTime())) return data;
                        return formato === 'br' ? date.toLocaleDateString('pt-BR') : date.toISOString().split('T')[0];
                    }
                    
                    let date = data instanceof Date ? data : new Date(data);
                    if (isNaN(date.getTime())) return data;
                    return formato === 'br' ? date.toLocaleDateString('pt-BR') : date.toISOString().split('T')[0];
                } catch (error) {
                    console.warn('Erro ao formatar data:', data, error);
                    return data;
                }
            }

            static formatarNumero(numero, casasDecimais = 2) {
                if (numero === null || numero === undefined || numero === '') return '0,00';
                const num = parseFloat(numero) || 0;
                return num.toLocaleString('pt-BR', { minimumFractionDigits: casasDecimais, maximumFractionDigits: casasDecimais });
            }

            static formatarHorasMinutos(horasDecimais) {
                if (!horasDecimais || horasDecimais <= 0) return '0h 00min';
                
                // Se for mais de 24 horas, mostrar em dias
                if (horasDecimais >= 24) {
                    const dias = Math.floor(horasDecimais / 24);
                    const horasRestantes = horasDecimais % 24;
                    const horas = Math.floor(horasRestantes);
                    const minutos = Math.round((horasRestantes - horas) * 60);
                    
                    if (minutos > 0) {
                        return `${dias}d ${horas}h ${minutos.toString().padStart(2, '0')}min`;
                    } else {
                        return `${dias}d ${horas}h`;
                    }
                }
                
                // Menos de 24 horas, mostrar apenas horas
                const horas = Math.floor(horasDecimais);
                const minutos = Math.round((horasDecimais - horas) * 60);
                
                return `${horas}h ${minutos.toString().padStart(2, '0')}min`;
            }

            static extrairHoraMinuto(dataHoraStr) {
                if (!dataHoraStr || dataHoraStr.trim() === '') {
                    return { hora: null, minuto: null };
                }
                
                try {
                    // Tentar vários formatos
                    const formatos = [
                        /(\d{1,2}):(\d{1,2}):?(\d{0,2})/,  // HH:MM ou HH:MM:SS
                        /(\d{1,2})h(\d{1,2})/,             // HHhMM
                        /(\d{1,2})\.(\d{1,2})/,            // HH.MM
                        /(\d{1,2})\s*[-:]\s*(\d{1,2})/     // HH - MM ou HH:MM com espaços
                    ];
                    
                    for (const formato of formatos) {
                        const match = dataHoraStr.match(formato);
                        if (match) {
                            const hora = parseInt(match[1]);
                            const minuto = parseInt(match[2]);
                            
                            if (hora >= 0 && hora <= 23 && minuto >= 0 && minuto <= 59) {
                                return { hora, minuto };
                            }
                        }
                    }
                    
                    return { hora: null, minuto: null };
                } catch (error) {
                    console.warn('Erro ao extrair hora/minuto:', dataHoraStr, error);
                    return { hora: null, minuto: null };
                }
            }

            // FUNÇÃO CORRIGIDA: Buscar Tipo de Carregamento
            static buscarTipoCarregamento(item) {
                // Primeiro, tentar encontrar a coluna exata
                const chavesExatas = [
                    'TIPO DE CARREGAMENTO',
                    'TIPO_CARREGAMENTO',
                    'TIPO CARREGAMENTO',
                    'CARREGAMENTO TIPO',
                    'TIPO DE CARGA',
                    'TIPO_CARGA',
                    'TIPO DE TRANSPORTE',
                    'MODALIDADE CARGA',
                    'MODALIDADE',
                    'TIPO'
                ];
                
                // Buscar primeiro por chaves exatas
                for (const chave of chavesExatas) {
                    if (item[chave] !== undefined && item[chave] !== null && item[chave].toString().trim() !== '') {
                        const valor = item[chave].toString().trim();
                        return this.normalizarTipoCarregamento(valor);
                    }
                }
                
                // Se não encontrou, verificar todas as chaves do objeto
                for (const chave in item) {
                    if (item.hasOwnProperty(chave)) {
                        const chaveUpper = chave.toUpperCase();
                        // Verificar se a chave contém palavras relacionadas a tipo/carregamento
                        if ((chaveUpper.includes('TIPO') && chaveUpper.includes('CARREGAMENTO')) || 
                            (chaveUpper.includes('TIPO') && chaveUpper.includes('CARGA')) ||
                            chaveUpper.includes('MODALIDADE')) {
                            const valor = item[chave].toString().trim();
                            if (valor && valor !== '') {
                                return this.normalizarTipoCarregamento(valor);
                            }
                        }
                    }
                }
                
                return '';
            }

            // NOVA FUNÇÃO: Normalizar tipo de carregamento
            static normalizarTipoCarregamento(valor) {
                if (!valor || valor.trim() === '') {
                    return '';
                }
                
                const valorUpper = valor.toString().toUpperCase().trim();
                
                // Mapear variações para os tipos padrão
                if (valorUpper.includes('FRACIONADO') || 
                    valorUpper === 'FRAC' || 
                    valorUpper === 'F' || 
                    valorUpper === 'FRACIONADA' ||
                    valorUpper.includes('FRACION') ||
                    valorUpper === 'FRAC.' ||
                    valorUpper === 'FRAC') {
                    return 'Fracionado';
                }
                
                if (valorUpper.includes('DEDICADO') || 
                    valorUpper === 'DED' || 
                    valorUpper === 'D' ||
                    valorUpper === 'DEDICADA' ||
                    valorUpper.includes('DEDIC') ||
                    valorUpper === 'DED.' ||
                    valorUpper === 'DEDICADO') {
                    return 'Dedicado';
                }
                
                if (valorUpper.includes('RETIRA') || 
                    valorUpper === 'RET' || 
                    valorUpper === 'R' || 
                    valorUpper.includes('CLIENTE RETIRA') || 
                    valorUpper.includes('RETIRA CLIENTE') ||
                    valorUpper.includes('CLIENTE') ||
                    valorUpper === 'RET.' ||
                    valorUpper === 'RETIRA CLIENTE') {
                    return 'Retira';
                }
                
                // Se não for nenhum dos padrões, retornar o valor original capitalizado
                return valor.charAt(0).toUpperCase() + valor.slice(1).toLowerCase();
            }

            static parseDateTimeFromGoogleSheets(dateTimeStr) {
                if (!dateTimeStr || dateTimeStr === '' || dateTimeStr === '-' || dateTimeStr === 'null') {
                    return null;
                }
                
                try {
                    // Se já for um objeto Date, retornar como está
                    if (dateTimeStr instanceof Date) {
                        return dateTimeStr;
                    }
                    
                    // Formato brasileiro completo: "dd/mm/yyyy hh:mm:ss"
                    const brPattern = /(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{1,2}):?(\d{0,2})/;
                    const brMatch = dateTimeStr.toString().match(brPattern);
                    
                    if (brMatch) {
                        const [, dia, mes, ano, hora, minuto, segundo] = brMatch;
                        const date = new Date(
                            parseInt(ano),
                            parseInt(mes) - 1,
                            parseInt(dia),
                            parseInt(hora || 0),
                            parseInt(minuto || 0),
                            parseInt(segundo || 0)
                        );
                        
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                    
                    // Formato brasileiro apenas data: "dd/mm/yyyy"
                    const dataOnlyPattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
                    const dataOnlyMatch = dateTimeStr.toString().match(dataOnlyPattern);
                    
                    if (dataOnlyMatch) {
                        const [, dia, mes, ano] = dataOnlyMatch;
                        const date = new Date(
                            parseInt(ano),
                            parseInt(mes) - 1,
                            parseInt(dia),
                            12, // Meio-dia para evitar problemas de fuso
                            0,
                            0
                        );
                        
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                    
                    // Formato ISO: "yyyy-mm-dd"
                    const isoPattern = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
                    const isoMatch = dateTimeStr.toString().match(isoPattern);
                    
                    if (isoMatch) {
                        const [, ano, mes, dia] = isoMatch;
                        const date = new Date(
                            parseInt(ano),
                            parseInt(mes) - 1,
                            parseInt(dia),
                            12, // Meio-dia para evitar problemas de fuso
                            0,
                            0
                        );
                        
                        if (!isNaN(date.getTime())) {
                            return date;
                        }
                    }
                    
                    // Tentar parsing direto
                    const date = new Date(dateTimeStr);
                    if (!isNaN(date.getTime())) {
                        return date;
                    }
                    
                    return null;
                    
                } catch (error) {
                    console.error('Erro ao fazer parsing de data/hora:', dateTimeStr, error);
                    return null;
                }
            }

            static calcularLeadTimeCorretamente(dataHoraEmpenho, dataHoraCarregamento) {
                if (!dataHoraEmpenho || dataHoraEmpenho === '' || 
                    !dataHoraCarregamento || dataHoraCarregamento === '') {
                    return 0;
                }
                
                try {
                    const empenho = this.parseDateTimeFromGoogleSheets(dataHoraEmpenho);
                    const carregamento = this.parseDateTimeFromGoogleSheets(dataHoraCarregamento);
                    
                    if (!empenho || !carregamento) {
                        return 0;
                    }
                    
                    if (isNaN(empenho.getTime()) || isNaN(carregamento.getTime())) {
                        return 0;
                    }
                    
                    const diferencaMs = carregamento - empenho;
                    
                    if (diferencaMs < 0) {
                        return 0;
                    }
                    
                    const horas = diferencaMs / (1000 * 60 * 60);
                    return horas;
                } catch (error) {
                    console.error('Erro ao calcular Lead Time:', error);
                    return 0;
                }
            }

            static calcularDiferencaHorasCompleta(dataHoraInicio, dataHoraFim) {
                if (!dataHoraInicio || !dataHoraFim) return 0;
                
                try {
                    const inicio = this.parseDateTimeFromGoogleSheets(dataHoraInicio);
                    const fim = this.parseDateTimeFromGoogleSheets(dataHoraFim);
                    
                    if (!inicio || !fim) {
                        return 0;
                    }
                    if (isNaN(inicio.getTime()) || isNaN(fim.getTime())) return 0;
                    
                    const diferencaMs = fim - inicio;
                    if (diferencaMs < 0) {
                        return 0;
                    }
                    
                    const horas = diferencaMs / (1000 * 60 * 60);
                    return horas;
                } catch (error) {
                    console.error('Erro ao calcular diferença de horas completa:', error);
                    return 0;
                }
            }

            static extrairApenasData(dataHora) {
                if (!dataHora) return '';
                
                try {
                    const date = this.parseDateTimeFromGoogleSheets(dataHora);
                    if (!date || isNaN(date.getTime())) {
                        return '';
                    }
                    
                    return this.formatarData(date, 'br');
                } catch (error) {
                    return '';
                }
            }

            static normalizarDataParaComparacao(dataStr) {
                if (!dataStr || dataStr === '' || dataStr === '-' || dataStr === 'null') {
                    return null;
                }
                
                try {
                    const apenasData = this.extrairApenasData(dataStr);
                    
                    if (!apenasData) {
                        const date = this.parseDateTimeFromGoogleSheets(dataStr);
                        if (!date || isNaN(date.getTime())) {
                            return null;
                        }
                        return this.formatarData(date, 'br');
                    }
                    
                    return apenasData;
                } catch (error) {
                    console.error('Erro ao normalizar data:', dataStr, error);
                    return null;
                }
            }

            static buscarValorPorChaves(item, chavesPossiveis) {
                if (!item || typeof item !== 'object') {
                    return '';
                }
                
                const chavesItem = Object.keys(item);
                
                // Primeiro, tentar match exato
                for (const chaveProcurada of chavesPossiveis) {
                    // Tentar chave normalizada (sem quebras de linha)
                    const chaveNormalizada = chaveProcurada.replace(/\n/g, ' ').trim();
                    
                    if (item[chaveProcurada] !== undefined && item[chaveProcurada] !== null && item[chaveProcurada] !== '') {
                        return item[chaveProcurada];
                    }
                    
                    // Tentar com chave normalizada
                    if (item[chaveNormalizada] !== undefined && item[chaveNormalizada] !== null && item[chaveNormalizada] !== '') {
                        return item[chaveNormalizada];
                    }
                    
                    // Buscar em todas as chaves com match parcial
                    for (const chaveItem of chavesItem) {
                        const chaveItemNormalizada = chaveItem.replace(/\n/g, ' ').trim();
                        if (chaveItemNormalizada === chaveNormalizada && item[chaveItem] && item[chaveItem] !== '') {
                            return item[chaveItem];
                        }
                    }
                }
                
                // Normalizar chaves (remover espaços extras, acentos, etc)
                const normalizarTexto = (texto) => {
                    return texto
                        .toLowerCase()
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                        .replace(/\s+/g, ' ')
                        .replace(/[^a-z0-9\s]/g, '')
                        .trim();
                };
                
                // Tentar match com normalização
                for (const chaveProcurada of chavesPossiveis) {
                    const chaveProcuradaNormalizada = normalizarTexto(chaveProcurada);
                    
                    for (const chaveItem of chavesItem) {
                        const chaveItemNormalizada = normalizarTexto(chaveItem);
                        
                        if (chaveItemNormalizada === chaveProcuradaNormalizada && item[chaveItem] && item[chaveItem] !== '') {
                            return item[chaveItem];
                        }
                        
                        const palavrasProcuradas = chaveProcuradaNormalizada.split(' ');
                        const todasPalavrasPresentes = palavrasProcuradas.every(palavra => 
                            chaveItemNormalizada.includes(palavra)
                        );
                        
                        if (todasPalavrasPresentes && item[chaveItem] && item[chaveItem] !== '') {
                            return item[chaveItem];
                        }
                    }
                }
                
                return '';
            }

            static debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Formatar data simples (dd/mm/aaaa)
            static formatarDataSimples(dataStr) {
                if (!dataStr || dataStr.trim() === '') return '';
                
                // Se já está no formato dd/mm/aaaa, retorna como está
                const brPattern = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
                if (brPattern.test(dataStr.trim())) {
                    return dataStr.trim();
                }
                
                // Caso contrário, tenta formatar
                return this.formatarData(dataStr, 'br');
            }

            // Converter string de paletes para número
            static parsePaletes(paletesStr) {
                if (!paletesStr || paletesStr.trim() === '') return 0;
                
                try {
                    // Remove espaços e substitui vírgula por ponto
                    const str = paletesStr.toString().trim().replace(',', '.');
                    const num = parseFloat(str);
                    
                    // Verifica se é um número válido
                    if (isNaN(num)) {
                        console.warn('Valor de paletes inválido:', paletesStr);
                        return 0;
                    }
                    
                    return num;
                } catch (error) {
                    console.error('Erro ao converter paletes:', paletesStr, error);
                    return 0;
                }
            }
            
            // Formatar tempo restante
            static formatarTempoRestante(milissegundos) {
                const minutos = Math.floor(milissegundos / 60000);
                const horas = Math.floor(minutos / 60);
                const minutosRestantes = minutos % 60;
                
                if (horas > 0) {
                    return `${horas}h ${minutosRestantes}min`;
                } else {
                    return `${minutos}min`;
                }
            }
        }

        // API Service com cache local
        class ApiService {
            constructor() {
                this.baseUrl = CONFIG.API_URL;
                this.isFetching = false;
            }

            async carregarFiliais() {
                try {
                    const response = await fetch(this.baseUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: 'action=listar_filiais'
                    });
                    return response.ok ? await response.json() : CONFIG.FILIAIS;
                } catch (error) {
                    return CONFIG.FILIAIS;
                }
            }

            obterNomeFilial(filialId) {
                if (filialId === 'TODAS') {
                    return 'TODAS AS FILIAIS';
                }
                
                const select = document.getElementById('filialSelect');
                const option = select.querySelector(`option[value="${filialId}"]`);
                return option ? option.dataset.nome || option.textContent : '';
            }

            async carregarDadosExpedicao(filialId, forcarAtualizacao = false) {
                // Verificar cache local primeiro
                if (!forcarAtualizacao) {
                    const dadosCache = dataCache.carregarDoLocalStorage(filialId, 'expedicao');
                    if (dadosCache) {
                        console.log('Usando dados de cache para expedição');
                        const filialNome = this.obterNomeFilial(filialId);
                        return this.processarDadosExpedicao(dadosCache, filialNome);
                    }
                }

                // Se não tem cache ou está forçando atualização, buscar da API
                try {
                    console.log('Buscando dados da API para expedição');
                    const url = filialId === 'TODAS' 
                        ? `${this.baseUrl}?aba=expedicao`
                        : `${this.baseUrl}?filial=${filialId}&aba=expedicao`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    
                    // Salvar no cache local
                    dataCache.salvarNoLocalStorage(filialId, 'expedicao', data);
                    
                    const filialNome = this.obterNomeFilial(filialId);
                    const processedData = this.processarDadosExpedicao(data, filialNome);
                    
                    return processedData;
                } catch (error) {
                    console.error('Erro ao buscar dados da API:', error);
                    
                    // Tentar usar cache como fallback mesmo se expirado
                    const dadosCache = dataCache.carregarDoLocalStorage(filialId, 'expedicao');
                    if (dadosCache) {
                        console.log('Usando cache como fallback após erro na API');
                        const filialNome = this.obterNomeFilial(filialId);
                        return this.processarDadosExpedicao(dadosCache, filialNome);
                    }
                    
                    throw new Error(`Falha ao carregar expedição: ${error.message}`);
                }
            }

            async carregarDadosRecebimento(filialId, forcarAtualizacao = false) {
                // Verificar cache local primeiro
                if (!forcarAtualizacao) {
                    const dadosCache = dataCache.carregarDoLocalStorage(filialId, 'recebimento');
                    if (dadosCache) {
                        console.log('Usando dados de cache para recebimento');
                        const filialNome = this.obterNomeFilial(filialId);
                        return this.processarDadosRecebimento(dadosCache, filialNome);
                    }
                }

                // Se não tem cache ou está forçando atualização, buscar da API
                try {
                    console.log('Buscando dados da API para recebimento');
                    const url = filialId === 'TODAS'
                        ? `${this.baseUrl}?aba=recebimento`
                        : `${this.baseUrl}?filial=${filialId}&aba=recebimento`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    
                    // Salvar no cache local
                    dataCache.salvarNoLocalStorage(filialId, 'recebimento', data);
                    
                    const filialNome = this.obterNomeFilial(filialId);
                    const processedData = this.processarDadosRecebimento(data, filialNome);
                    
                    return processedData;
                } catch (error) {
                    console.error('Erro ao buscar dados da API:', error);
                    
                    // Tentar usar cache como fallback mesmo se expirado
                    const dadosCache = dataCache.carregarDoLocalStorage(filialId, 'recebimento');
                    if (dadosCache) {
                        console.log('Usando cache como fallback após erro na API');
                        const filialNome = this.obterNomeFilial(filialId);
                        return this.processarDadosRecebimento(dadosCache, filialNome);
                    }
                    
                    throw new Error(`Falha ao carregar recebimento: ${error.message}`);
                }
            }

            async carregarDadosEmAndamento(filialId, forcarAtualizacao = false) {
                // Verificar cache local primeiro
                if (!forcarAtualizacao) {
                    const dadosCache = dataCache.carregarDoLocalStorage(filialId, 'emandamento');
                    if (dadosCache) {
                        console.log('Usando dados de cache para em andamento');
                        const filialNome = this.obterNomeFilial(filialId);
                        return this.processarDadosEmAndamento(dadosCache, filialNome);
                    }
                }

                // Se não tem cache ou está forçando atualização, buscar da API
                try {
                    console.log('Buscando dados da API para em andamento');
                    const url = filialId === 'TODAS'
                        ? `${this.baseUrl}?aba=emandamento`
                        : `${this.baseUrl}?filial=${filialId}&aba=emandamento`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    
                    // Salvar no cache local
                    dataCache.salvarNoLocalStorage(filialId, 'emandamento', data);
                    
                    const filialNome = this.obterNomeFilial(filialId);
                    const processedData = this.processarDadosEmAndamento(data, filialNome);
                    
                    return processedData;
                } catch (error) {
                    console.error('Erro ao buscar dados da API:', error);
                    
                    // Tentar usar cache como fallback mesmo se expirado
                    const dadosCache = dataCache.carregarDoLocalStorage(filialId, 'emandamento');
                    if (dadosCache) {
                        console.log('Usando cache como fallback após erro na API');
                        const filialNome = this.obterNomeFilial(filialId);
                        return this.processarDadosEmAndamento(dadosCache, filialNome);
                    }
                    
                    throw new Error(`Falha ao carregar dados em andamento: ${error.message}`);
                }
            }

            processarDadosExpedicao(dados, filialNome) {
                console.log('=== PROCESSANDO DADOS DE EXPEDIÇÃO ===');
                console.log('Total de registros:', dados.length);
                
                // DEBUG: Mostrar todas as chaves do primeiro item
                if (dados.length > 0) {
                    console.log('Chaves disponíveis no primeiro item:', Object.keys(dados[0]));
                }
                
                return dados.map((item, index) => {
                    let filialItem = item.FILIAL || '';
                    if (!filialItem && filialNome) {
                        filialItem = filialNome;
                    }
                    
                    // DEBUG: Buscar tipo de carregamento específico
                    const tipoCarregamento = Utils.buscarTipoCarregamento(item);
                    
                    // Buscar os valores com os novos nomes das colunas
                    const dataEmpenho = Utils.buscarValorPorChaves(item, [
                        'DATA E  HORA EMPENHO',
                        'DATA E HORA EMPENHO',
                        'DATA EMPENHO',
                        'EMPENHO',
                        'DATA/HORA EMPENHO',
                        'DATA_EMPENHO',
                        'HORA EMPENHO'
                    ]);
                    
                    const separacaoInicio = Utils.buscarValorPorChaves(item, [
                        'DATA E HORA SEPARAÇÃO INICIAL',
                        'SEPARAÇÃO INICIAL',
                        'INICIO SEPARAÇÃO'
                    ]);
                    
                    const separacaoFinal = Utils.buscarValorPorChaves(item, [
                        'DATA E HORA HORA SEPARAÇÃO FINAL',
                        'SEPARAÇÃO FINAL',
                        'FIM SEPARAÇÃO'
                    ]);
                    
                    const ocEnviada = Utils.buscarValorPorChaves(item, [
                        'DATA E HORA OC ENVIADA',
                        'OC ENVIADA',
                        'DATA OC ENVIADA'
                    ]);
                    
                    const chegadaTransportadora = Utils.buscarValorPorChaves(item, [
                        'DATA E HORA CHEGADA TRANSPORTADORA',
                        'CHEGADA TRANSPORTADORA',
                        'TRANSPORTADORA CHEGADA'
                    ]);
                    
                    const dataCarregamento = Utils.buscarValorPorChaves(item, [
                        'DATA E HORA CARREGAMENTO',
                        'DATA CARREGAMENTO',
                        'CARREGAMENTO',
                        'DATA/HORA CARREGAMENTO',
                        'DATA_CARREGAMENTO',
                        'HORA CARREGAMENTO'
                    ]);
                    
                    const horaProgramada = Utils.buscarValorPorChaves(item, [
                        'HORA PROGRAMADA',
                        'HORARIO PROGRAMADO'
                    ]);
                    
                    // Corrigir o parsing de paletes
                    const paletesStr = Utils.buscarValorPorChaves(item, [
                        'PALETES',
                        'PALET',
                        'TOTAL PALETES',
                        'QTDE PALETES'
                    ]);
                    
                    const paletes = Utils.parsePaletes(paletesStr);
                    
                    // Calcular tempos
                    const tempoSeparacao = Utils.calcularDiferencaHorasCompleta(
                        separacaoInicio,
                        separacaoFinal
                    );
                    
                    // NOVA LÓGICA: Tempo de carregamento (chegada transportadora -> carregamento)
                    const tempoCarregamento = Utils.calcularDiferencaHorasCompleta(
                        chegadaTransportadora,
                        dataCarregamento
                    );
                    
                    // NOVA LÓGICA: Tempo total processo (OC enviada -> carregamento)
                    const tempoTotalProcesso = Utils.calcularDiferencaHorasCompleta(
                        ocEnviada,
                        dataCarregamento
                    );
                    
                    // NOVA LÓGICA: Tempo espera transportadora (OC enviada -> chegada transportadora)
                    const tempoEsperaTransportadora = Utils.calcularDiferencaHorasCompleta(
                        ocEnviada,
                        chegadaTransportadora
                    );
                    
                    const leadTime = Utils.calcularLeadTimeCorretamente(
                        dataEmpenho,
                        dataCarregamento
                    );
                    
                    // NOVA LÓGICA: Análise de atrasos
                    let tipoAtraso = 'NO PRAZO';
                    let temAtraso = false;
                    
                    // Verificar atraso da transportadora (OC enviada -> chegada transportadora > 3 horas)
                    if (ocEnviada && chegadaTransportadora) {
                        if (tempoEsperaTransportadora > 3) {
                            tipoAtraso = 'ATRASO TRANSPORTADORA';
                            temAtraso = true;
                        }
                    }
                    
                    // Verificar atraso da expedição (OC enviada -> carregamento > 3 horas)
                    // Só considerar se não for atraso da transportadora
                    if (!temAtraso && ocEnviada && dataCarregamento) {
                        if (tempoTotalProcesso > 3) {
                            tipoAtraso = 'ATRASO EXPEDIÇÃO';
                            temAtraso = true;
                        }
                    }
                    
                    // Se não tem OC Enviada ou Carregamento, não podemos calcular
                    if (!ocEnviada || !dataCarregamento) {
                        tipoAtraso = 'SEM DADOS';
                    }
                    
                    const dataCarregamentoNormalizada = Utils.normalizarDataParaComparacao(dataCarregamento);
                    const dataEmpenhoNormalizada = Utils.normalizarDataParaComparacao(dataEmpenho);
                    const dataOCEnviadaNormalizada = Utils.normalizarDataParaComparacao(ocEnviada);
                    const dataChegadaTransportadoraNormalizada = Utils.normalizarDataParaComparacao(chegadaTransportadora);

                    return {
                        ...item,
                        FILIAL: filialItem || dashboardApp.filialNome || '',
                        PALETES: paletes,
                        PALETES_FORMATADO: Utils.formatarNumero(paletes, 2),
                        
                        // TIPO DE CARREGAMENTO - CORRIGIDO
                        TIPO_CARREGAMENTO: tipoCarregamento,
                        TIPO_CARREGAMENTO_ORIGINAL: item['TIPO DE CARREGAMENTO'] || '', // Para debug
                        
                        // Datas formatadas
                        DATA_EMPENHO_FORMATADA: Utils.formatarDataSimples(dataEmpenho),
                        DATA_CARREG_FORMATADA: Utils.formatarDataSimples(dataCarregamento),
                        DATA_OC_ENVIADA_FORMATADA: Utils.formatarDataSimples(ocEnviada),
                        DATA_CHEGADA_TRANSP_FORMATADA: Utils.formatarDataSimples(chegadaTransportadora),
                        
                        // Datas normalizadas para filtro
                        DATA_EMPENHO_NORMALIZADA: dataEmpenhoNormalizada,
                        DATA_CARREG_NORMALIZADA: dataCarregamentoNormalizada,
                        DATA_OC_ENVIADA_NORMALIZADA: dataOCEnviadaNormalizada,
                        DATA_CHEGADA_TRANSP_NORMALIZADA: dataChegadaTransportadoraNormalizada,
                        
                        // Datas completas
                        DATA_EMPENHO_COMPLETA: dataEmpenho,
                        DATA_CARREG_COMPLETA: dataCarregamento,
                        DATA_OC_ENVIADA_COMPLETA: ocEnviada,
                        DATA_CHEGADA_TRANSP_COMPLETA: chegadaTransportadora,
                        
                        // Tempos calculados - NOVA LÓGICA
                        TEMPO_SEPARACAO: tempoSeparacao,
                        TEMPO_SEPARACAO_FORMATADO: Utils.formatarHorasMinutos(tempoSeparacao),
                        
                        // Tempo de carregamento (chegada transportadora -> carregamento)
                        TEMPO_CARREGAMENTO: tempoCarregamento,
                        TEMPO_CARREGAMENTO_FORMATADO: Utils.formatarHorasMinutos(tempoCarregamento),
                        
                        // Tempo total processo (OC enviada -> carregamento)
                        TEMPO_TOTAL_PROCESSO: tempoTotalProcesso,
                        TEMPO_TOTAL_PROCESSO_FORMATADO: tempoTotalProcesso !== null ? 
                            Utils.formatarHorasMinutos(tempoTotalProcesso) : '-',
                        
                        // Tempo espera transportadora (OC enviada -> chegada transportadora)
                        TEMPO_ESPERA_TRANSPORTADORA: tempoEsperaTransportadora,
                        TEMPO_ESPERA_TRANSPORTADORA_FORMATADO: tempoEsperaTransportadora !== null ? 
                            Utils.formatarHorasMinutos(tempoEsperaTransportadora) : '-',
                        
                        LEAD_TIME: leadTime,
                        LEAD_TIME_FORMATADO: Utils.formatarHorasMinutos(leadTime),
                        
                        // Novos campos para status de atraso
                        HORA_PROGRAMADA: horaProgramada || '',
                        TIPO_ATRASO: tipoAtraso,
                        TEM_ATRASO: temAtraso,
                        TEMPO_ESPERA_TRANSP_CALCULADO: tempoEsperaTransportadora,
                        TEMPO_TOTAL_PROCESSO_CALCULADO: tempoTotalProcesso,
                        
                        TRANSPORTADORA: item.TRANSPORTADORA || item.TRANSPORTADORAS || '',
                        TEM_ERRO: item['HOUVE ERRO?'] ? item['HOUVE ERRO?'].toLowerCase() === 'sim' : false,
                        ERRO_DETALHE: item['TIPO DE ERRO'] || item['QUAL ERRO?'] || item['ERRO'] || ''
                    };
                });
            }

            processarDadosRecebimento(dados, filialNome) {
                return dados.map(item => {
                    let filialItem = item.FILIAL || '';
                    if (!filialItem && filialNome) {
                        filialItem = filialNome;
                    }
                    
                    let dataRecebimentoCompleta = item['DATA DE RECEBIMENTO'] || '';
                    if (dataRecebimentoCompleta && !dataRecebimentoCompleta.includes(':')) {
                        dataRecebimentoCompleta = dataRecebimentoCompleta + ' 12:00:00';
                    }
                    
                    let dataLancamentoCompleta = item['DATA LANÇAMENTO'] || '';
                    if (dataLancamentoCompleta && !dataLancamentoCompleta.includes(':')) {
                        dataLancamentoCompleta = dataLancamentoCompleta + ' 12:00:00';
                    }
                    
                    const dataRecebimentoNormalizada = Utils.normalizarDataParaComparacao(dataRecebimentoCompleta);
                    const dataLancamentoNormalizada = Utils.normalizarDataParaComparacao(dataLancamentoCompleta);
                    
                    return {
                        ...item,
                        FILIAL: filialItem || dashboardApp.filialNome || '',
                        TRANSPORTADORA: item.TRANSPORTADORAS || item.TRANSPORTADORA || '',
                        ARMAZEM: item['ARMAZEM LANÇADO'] || item.ARMAZEM || '',
                        'HOUVE ERRO?': item['HOUVE ERRO?'] || '',
                        'QUAL ERRO?': item['QUAL ERRO?'] || item['TIPO DE ERRO'] || '',
                        NF: item.NF || item['NOTA FISCAL'] || '',
                        'CLIENTE/FILIAL': item['CLIENTE/FILIAL'] || item.CLIENTE || item.FILIAL || '',
                        
                        'DATA DE RECEBIMENTO': dataRecebimentoCompleta,
                        'DATA LANÇAMENTO': dataLancamentoCompleta,
                        
                        DATA_RECEBIMENTO_FORMATADA: Utils.formatarDataSimples(item['DATA DE RECEBIMENTO']),
                        DATA_LANCAMENTO_FORMATADA: Utils.formatarDataSimples(item['DATA LANÇAMENTO']),
                        
                        DATA_RECEBIMENTO_NORMALIZADA: dataRecebimentoNormalizada,
                        DATA_LANCAMENTO_NORMALIZADA: dataLancamentoNormalizada,
                        
                        STATUS_LANCAMENTO: item['DATA LANÇAMENTO'] ? 'Lançado' : 'Pendente',
                        TEM_ERRO: item['HOUVE ERRO?'] ? item['HOUVE ERRO?'].toLowerCase() === 'sim' : false
                    };
                });
            }

            processarDadosEmAndamento(dados, filialNome) {
                // Filtrar linhas vazias
                const dadosFiltrados = dados.filter(item => {
                    const hasData = item.PEDIDOS || item.CLIENTE || item['NOTA FISCAL'] || item.TRANSPORTADORA;
                    return hasData && hasData.toString().trim() !== '';
                });
                
                // DEBUG: Mostrar chaves disponíveis
                if (dadosFiltrados.length > 0) {
                    console.log('=== DADOS EM ANDAMENTO ===');
                    console.log('Chaves disponíveis:', Object.keys(dadosFiltrados[0]));
                }
                
                return dadosFiltrados.map((item, index) => {
                    let filialItem = item.FILIAL || '';
                    if (!filialItem && filialNome) {
                        filialItem = filialNome;
                    }
                    
                    // Corrigir o parsing de paletes
                    const paletesStr = Utils.buscarValorPorChaves(item, [
                        'PALETES',
                        'PALET',
                        'TOTAL PALETES',
                        'QTDE PALETES'
                    ]);
                    
                    const paletes = Utils.parsePaletes(paletesStr);
                    
                    // CORREÇÃO APLICADA: Tipo de Carregamento usando a nova função
                    const tipoCarregamento = Utils.buscarTipoCarregamento(item);
                    
                    // Buscar datas de separação com nomes corrigidos
                    const separacaoInicio = Utils.buscarValorPorChaves(item, [
                        'DATA E HORA SEPARAÇÃO INICIAL',
                        'SEPARAÇÃO INICIAL',
                        'INICIO SEPARAÇÃO',
                        'DATA SEPARAÇÃO INICIO',
                        'INICIO SEPARACAO',
                        'DATA E HORA SEPARACAO INICIAL',
                        'DATA SEPARACAO INICIAL'
                    ]);
                    
                    const separacaoFinal = Utils.buscarValorPorChaves(item, [
                        'DATA E HORA HORA SEPARAÇÃO FINAL',
                        'DATA E HORA SEPARAÇÃO FINAL',
                        'SEPARAÇÃO FINAL',
                        'FIM SEPARAÇÃO',
                        'SEPARACAO FINAL',
                        'DATA SEPARAÇÃO FIM',
                        'DATA E HORA SEPARACAO FINAL'
                    ]);
                    
                    // LÓGICA MELHORADA PARA STATUS DE SEPARAÇÃO
                    let statusSeparacao = 'Falta Separação';
                    let estaEmSeparacao = false;
                    let separacaoCompleta = false;
                    
                    // Verificar se tem data de início
                    const temInicio = separacaoInicio && separacaoInicio.trim() !== '' && 
                                     separacaoInicio !== '-' && separacaoInicio.toLowerCase() !== 'null';
                    
                    // Verificar se tem data de fim
                    const temFim = separacaoFinal && separacaoFinal.trim() !== '' && 
                                  separacaoFinal !== '-' && separacaoFinal.toLowerCase() !== 'null';
                    
                    if (temInicio) {
                        if (temFim) {
                            statusSeparacao = 'Separado';
                            separacaoCompleta = true;
                        } else {
                            statusSeparacao = 'Em Separação';
                            estaEmSeparacao = true;
                        }
                    } else {
                        statusSeparacao = 'Falta Separação';
                    }
                    
                    // Criar tooltip informativo
                    let tooltipText = '';
                    if (temInicio) {
                        tooltipText += `Início: ${separacaoInicio}`;
                    }
                    if (temFim) {
                        tooltipText += tooltipText ? '\n' : '';
                        tooltipText += `Fim: ${separacaoFinal}`;
                    }
                    if (!tooltipText) {
                        tooltipText = 'Sem dados de separação';
                    }
                    
                    return {
                        ...item,
                        FILIAL: filialItem || dashboardApp.filialNome || '',
                        PALETES: paletes,
                        PALETES_FORMATADO: Utils.formatarNumero(paletes, 2),
                        TRANSPORTADORA: item.TRANSPORTADORA || '',
                        // CORREÇÃO APLICADA
                        TIPO_CARREGAMENTO: tipoCarregamento,
                        TIPO_CARREGAMENTO_ORIGINAL: item['TIPO DE CARREGAMENTO'] || '', // Para debug
                        SEPARACAO_INICIO: separacaoInicio,
                        SEPARACAO_FINAL: separacaoFinal,
                        ESTA_EM_SEPARACAO: estaEmSeparacao,
                        SEPARACAO_COMPLETA: separacaoCompleta,
                        STATUS_SEPARACAO: statusSeparacao,
                        TEM_INICIO_SEPARACAO: temInicio,
                        TEM_FIM_SEPARACAO: temFim,
                        TOOLTIP_SEPARACAO: tooltipText
                    };
                });
            }

            limparCacheLocal(filialId) {
                dataCache.limparCacheLocal(filialId);
            }
        }

        const apiService = new ApiService();

        // Table Manager
        class TableManager {
            constructor() {
                this.expedicaoTable = document.getElementById('tabelaExpedicao');
                this.recebimentoTable = document.getElementById('tabelaRecebimento');
                this.emAndamentoTable = document.getElementById('tabelaEmAndamento');
                this.tbodyExpedicao = document.getElementById('tbodyExpedicao');
                this.tbodyRecebimento = document.getElementById('tbodyRecebimento');
                this.tbodyEmAndamento = document.getElementById('tbodyEmAndamento');
            }

            renderizarExpedicao(dados) {
                this.tbodyExpedicao.innerHTML = dados && dados.length > 0 
                    ? dados.map(item => this.criarLinhaExpedicao(item)).join('')
                    : this.criarLinhaVazia(20); // Atualizado para 20 colunas
                this.expedicaoTable.style.display = 'table';
            }

            renderizarRecebimento(dados) {
                this.tbodyRecebimento.innerHTML = dados && dados.length > 0 
                    ? dados.map(item => this.criarLinhaRecebimento(item)).join('')
                    : this.criarLinhaVazia(9);
                this.recebimentoTable.style.display = 'table';
            }

            renderizarEmAndamento(dados) {
                this.tbodyEmAndamento.innerHTML = dados && dados.length > 0 
                    ? dados.map(item => this.criarLinhaEmAndamento(item)).join('')
                    : this.criarLinhaVazia(10); // Atualizado para 10 colunas
                this.emAndamentoTable.style.display = 'table';
            }

            criarLinhaExpedicao(item) {
                const temErro = item.TEM_ERRO;
                const statusErro = temErro ? '<span class="status-badge status-danger">Erro</span>' : '<span class="status-badge status-success">OK</span>';
                
                // Status de atraso com NOVA LÓGICA
                let statusAtraso = '';
                let rowClass = '';
                
                switch(item.TIPO_ATRASO) {
                    case 'ATRASO TRANSPORTADORA':
                        const tooltipTransp = `Tempo espera transportadora: ${item.TEMPO_ESPERA_TRANSPORTADORA_FORMATADO}\n(OC Enviada → Chegada Transp.)`;
                        statusAtraso = `<span class="status-badge status-atraso-transportadora" title="${tooltipTransp}">ATRASO TRANSPORTADORA</span>`;
                        rowClass = 'atraso-transportadora';
                        break;
                        
                    case 'ATRASO EXPEDIÇÃO':
                        const tooltipExp = `Tempo total processo: ${item.TEMPO_TOTAL_PROCESSO_FORMATADO}\n(OC Enviada → Carregamento)`;
                        statusAtraso = `<span class="status-badge status-atraso-expedicao" title="${tooltipExp}">ATRASO EXPEDIÇÃO</span>`;
                        rowClass = 'atraso-expedicao';
                        break;
                        
                    case 'NO PRAZO':
                        statusAtraso = '<span class="status-badge status-no-prazo">NO PRAZO</span>';
                        break;
                        
                    case 'SEM DADOS':
                        statusAtraso = '<span class="status-badge status-sem-dados">SEM DADOS</span>';
                        break;
                        
                    default:
                        statusAtraso = '<span class="status-badge status-info">INDEFINIDO</span>';
                }
                
                return `<tr class="${rowClass} ${temErro ? 'error-row' : ''}">
                    <td>${item.FILIAL || ''}</td>
                    <td>${item.PEDIDOS || ''}</td>
                    <td>${item.CLIENTE || ''}</td>
                    <td>${item.CIDADE || ''}</td>
                    <td>${item.UF || ''}</td>
                    <td>${item.PALETES_FORMATADO}</td>
                    <td>${item['NOTA FISCAL'] || ''}</td>
                    <td>${item.DATA_EMPENHO_FORMATADA || ''}</td>
                    <td>${item.DATA_OC_ENVIADA_FORMATADA || ''}</td>
                    <td>${item.DATA_CHEGADA_TRANSP_FORMATADA || ''}</td>
                    <td>${item.DATA_CARREG_FORMATADA || ''}</td>
                    <td>${item.TEMPO_SEPARACAO_FORMATADO}</td>
                    <td>${item.TEMPO_CARREGAMENTO_FORMATADO}</td>
                    <td>${item.TRANSPORTADORA || ''}</td>
                    <td>${item.TIPO_CARREGAMENTO || '-'}</td>
                    <td>${item.HORA_PROGRAMADA || ''}</td>
                    <td>${item.LEAD_TIME_FORMATADO}</td>
                    <td>${statusAtraso}</td>
                    <td>${statusErro}</td>
                    <td>${item.ERRO_DETALHE || '-'}</td>
                </tr>`;
            }

            criarLinhaRecebimento(item) {
                const temErro = item.TEM_ERRO;
                const statusLancamento = item.STATUS_LANCAMENTO === 'Lançado' 
                    ? '<span class="status-badge status-success">Lançado</span>'
                    : '<span class="status-badge status-warning">Pendente</span>';
                const statusErro = temErro ? '<span class="status-badge status-danger">Erro</span>' : '<span class="status-badge status-success">OK</span>';
                
                return `<tr ${temErro ? 'class="error-row"' : ''}>
                    <td>${item.FILIAL || ''}</td>
                    <td>${item.NF || ''}</td>
                    <td>${item['CLIENTE/FILIAL'] || ''}</td>
                    <td>${item.TRANSPORTADORA || ''}</td>
                    <td>${item.DATA_RECEBIMENTO_FORMATADA}</td>
                    <td>${item.DATA_LANCAMENTO_FORMATADA || 'Pendente'}</td>
                    <td>${item.ARMAZEM || ''}</td>
                    <td>${statusLancamento}</td>
                    <td>${statusErro}</td>
                </tr>`;
            }

            criarLinhaEmAndamento(item) {
                let statusClass = '';
                let statusText = item.STATUS_SEPARACAO || 'Indefinido';
                
                switch(item.STATUS_SEPARACAO) {
                    case 'Em Separação':
                        statusClass = 'status-em-separacao';
                        break;
                    case 'Falta Separação':
                        statusClass = 'status-falta-separacao';
                        break;
                    case 'Separado':
                        statusClass = 'status-separado';
                        break;
                    default:
                        statusClass = 'status-info';
                        statusText = 'Indefinido';
                }
                
                const statusSeparacao = `<span class="status-badge ${statusClass}" title="${item.TOOLTIP_SEPARACAO || ''}">${statusText}</span>`;
                
                return `<tr>
                    <td>${item.FILIAL || ''}</td>
                    <td>${item.PEDIDOS || ''}</td>
                    <td>${item.CLIENTE || ''}</td>
                    <td>${item.CIDADE || ''}</td>
                    <td>${item.UF || ''}</td>
                    <td>${item.PALETES_FORMATADO}</td>
                    <td>${item['NOTA FISCAL'] || ''}</td>
                    <td>${item.TRANSPORTADORA || ''}</td>
                    <td>${item.TIPO_CARREGAMENTO || '-'}</td>
                    <td>${statusSeparacao}</td>
                </tr>`;
            }

            criarLinhaVazia(colunas) {
                return `<tr><td colspan="${colunas}" style="text-align: center; padding: 40px; color: #666;">Nenhum dado encontrado</td></tr>`;
            }

            ocultarTabelas() {
                this.expedicaoTable.style.display = 'none';
                this.recebimentoTable.style.display = 'none';
                this.emAndamentoTable.style.display = 'none';
            }
        }

        const tableManager = new TableManager();

        // Filter Manager - CORREÇÃO APLICADA
        class FilterManager {
            constructor() {
                this.initElements();
                this.debouncedFilter = Utils.debounce(() => dashboardApp.aplicarFiltros(), 300);
                this.advancedFiltersVisible = false;
                this.initAdvancedFilters();
                this.initClearButtons();
            }

            initElements() {
                this.elements = {
                    // Expedição
                    numeroPedido: document.getElementById('numeroPedido'),
                    clienteExpedicao: document.getElementById('clienteExpedicao'),
                    transportadoraExpedicao: document.getElementById('transportadoraExpedicao'),
                    ufExpedicao: document.getElementById('ufExpedicao'),
                    dataCarregamentoInicio: document.getElementById('dataCarregamentoInicio'),
                    dataCarregamentoFim: document.getElementById('dataCarregamentoFim'),
                    statusErroExpedicao: document.getElementById('statusErroExpedicao'),
                    tipoErroExpedicao: document.getElementById('tipoErroExpedicao'),
                    statusAtrasoExpedicao: document.getElementById('statusAtrasoExpedicao'),
                    // NOVO FILTRO: Tipo de Carregamento - CORRIGIDO
                    tipoCarregamentoExpedicao: document.getElementById('tipoCarregamentoExpedicao'),
                    // Avançados
                    paletesMin: document.getElementById('paletesMin'),
                    paletesMax: document.getElementById('paletesMax'),
                    leadTimeMin: document.getElementById('leadTimeMin'),
                    leadTimeMax: document.getElementById('leadTimeMax'),
                    tempoSeparacaoMin: document.getElementById('tempoSeparacaoMin'),
                    tempoSeparacaoMax: document.getElementById('tempoSeparacaoMax'),
                    cidadeExpedicao: document.getElementById('cidadeExpedicao'),
                    notaFiscalExpedicao: document.getElementById('notaFiscalExpedicao'),
                    
                    // Recebimento
                    numeroNota: document.getElementById('numeroNota'),
                    clienteRecebimento: document.getElementById('clienteRecebimento'),
                    transportadoraRecebimento: document.getElementById('transportadoraRecebimento'),
                    dataRecebimentoInicio: document.getElementById('dataRecebimentoInicio'),
                    dataRecebimentoFim: document.getElementById('dataRecebimentoFim'),
                    dataLancamentoInicio: document.getElementById('dataLancamentoInicio'),
                    dataLancamentoFim: document.getElementById('dataLancamentoFim'),
                    armazemRecebimento: document.getElementById('armazemRecebimento'),
                    statusLancamento: document.getElementById('statusLancamento'),
                    statusErroRecebimento: document.getElementById('statusErroRecebimento'),
                    
                    // Em Andamento
                    pedidoAndamento: document.getElementById('pedidoAndamento'),
                    clienteAndamento: document.getElementById('clienteAndamento'),
                    transportadoraAndamento: document.getElementById('transportadoraAndamento'),
                    ufAndamento: document.getElementById('ufAndamento'),
                    cidadeAndamento: document.getElementById('cidadeAndamento'),
                    statusSeparacao: document.getElementById('statusSeparacao'),
                    // NOVO FILTRO: Tipo de Carregamento (Em Andamento) - CORRIGIDO
                    tipoCarregamentoAndamento: document.getElementById('tipoCarregamentoAndamento')
                };

                // Adicionar validação em tempo real
                Object.values(this.elements).forEach(element => {
                    if (element) {
                        element.addEventListener('input', () => this.debouncedFilter());
                        element.addEventListener('change', () => this.debouncedFilter());
                        
                        if (element.type === 'number') {
                            element.addEventListener('blur', () => {
                                if (element.value && parseFloat(element.value) < 0) {
                                    element.value = '';
                                }
                            });
                        }
                    }
                });
            }

            initClearButtons() {
                // Adicionar event listeners para botões de limpar
                document.querySelectorAll('.filter-clear-btn').forEach(button => {
                    const fieldId = button.getAttribute('data-for');
                    const field = document.getElementById(fieldId);
                    
                    if (field) {
                        button.addEventListener('click', () => {
                            this.clearField(field);
                        });
                        
                        // Atualizar visibilidade do botão
                        const updateVisibility = () => {
                            const hasValue = field.value && field.value.trim() !== '';
                            button.style.display = hasValue ? 'flex' : 'none';
                        };
                        
                        field.addEventListener('input', updateVisibility);
                        field.addEventListener('change', updateVisibility);
                        updateVisibility();
                    }
                });
            }

            clearField(field) {
                if (field.tagName === 'SELECT') {
                    field.selectedIndex = 0;
                } else {
                    field.value = '';
                }
                field.dispatchEvent(new Event('change'));
                dashboardApp.aplicarFiltros();
            }

            extrairDataItem(dataItem) {
                if (!dataItem || dataItem.trim() === '') return null;
                
                // Formato: "dd/mm/yyyy" ou "dd/mm/yyyy hh:mm:ss"
                const match = dataItem.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);
                if (match) {
                    const [, dia, mes, ano] = match;
                    return {
                        dia: parseInt(dia),
                        mes: parseInt(mes),
                        ano: parseInt(ano),
                        timestamp: new Date(parseInt(ano), parseInt(mes) - 1, parseInt(dia)).getTime()
                    };
                }
                return null;
            }

            converterDataFiltro(dataFiltro) {
                if (!dataFiltro) return null;
                
                // Formato do input date: "yyyy-mm-dd"
                const partes = dataFiltro.split('-');
                if (partes.length === 3) {
                    return {
                        dia: parseInt(partes[2]),
                        mes: parseInt(partes[1]),
                        ano: parseInt(partes[0]),
                        timestamp: new Date(parseInt(partes[0]), parseInt(partes[1]) - 1, parseInt(partes[2])).getTime()
                    };
                }
                return null;
            }

            initAdvancedFilters() {
                const toggleBtn = document.getElementById('toggleAdvancedFilters');
                if (toggleBtn) {
                    toggleBtn.addEventListener('click', () => {
                        this.toggleAdvancedFilters();
                    });
                }
            }

            toggleAdvancedFilters() {
                this.advancedFiltersVisible = !this.advancedFiltersVisible;
                const advancedFilters = document.getElementById('advancedFiltersExpedicao');
                const toggleBtn = document.getElementById('toggleAdvancedFilters');
                
                if (advancedFilters) {
                    advancedFilters.style.display = this.advancedFiltersVisible ? 'grid' : 'none';
                    toggleBtn.innerHTML = this.advancedFiltersVisible 
                        ? '<i class="fas fa-eye-slash"></i>' 
                        : '<i class="fas fa-sliders-h"></i>';
                    toggleBtn.title = this.advancedFiltersVisible 
                        ? 'Ocultar filtros avançados' 
                        : 'Mostrar filtros avançados';
                }
            }

            // CORREÇÃO APLICADA: Preencher tipos de carregamento
            preencherTiposCarregamento(dados, selectId) {
                const tipos = new Set();
                
                // Coletar todos os tipos de carregamento únicos
                dados.forEach(item => {
                    const tipo = item.TIPO_CARREGAMENTO || '';
                    if (tipo && tipo.trim() !== '') {
                        // Usar o tipo já normalizado
                        const tipoNormalizado = tipo.toString().trim();
                        tipos.add(tipoNormalizado);
                    }
                });
                
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Todos</option>';
                
                // Adicionar opções fixas primeiro
                const opcoesFixas = ['Fracionado', 'Dedicado', 'Retira'];
                
                opcoesFixas.forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo;
                    option.textContent = tipo;
                    select.appendChild(option);
                });
                
                // Adicionar opção para registros sem tipo
                select.appendChild(document.createElement('option'));
                
                // Depois adicionar outros tipos encontrados
                const outrosTipos = Array.from(tipos).filter(tipo => 
                    !opcoesFixas.some(fixo => 
                        tipo.toLowerCase().includes(fixo.toLowerCase()) || 
                        fixo.toLowerCase().includes(tipo.toLowerCase())
                    )
                );
                
                outrosTipos.sort().forEach(tipo => {
                    const option = document.createElement('option');
                    option.value = tipo;
                    option.textContent = tipo;
                    select.appendChild(option);
                });
                
                // Adicionar opção "Sem Dados" (valor vazio)
                const optionSemDados = document.createElement('option');
                optionSemDados.value = '';
                optionSemDados.textContent = 'Sem Dados';
                select.appendChild(optionSemDados);
                
                if (currentValue) {
                    select.value = currentValue;
                }
            }

            // CORREÇÃO APLICADA: Filtro de tipo de carregamento - FUNÇÃO REESCRITA
            aplicarFiltroTipoCarregamento(item, filtroValue, campoTipo) {
                if (!filtroValue) return true;
                
                const tipoItem = (item[campoTipo] || '').toString().trim();
                
                // Para filtrar por "Sem Dados" (valor vazio no filtro)
                if (filtroValue === '') {
                    return tipoItem === '';
                }
                
                // Se o item não tem tipo e o filtro não é "Sem Dados", retorna false
                if (tipoItem === '') {
                    return false;
                }
                
                // Normalizar ambos para comparação (remover acentos, converter para maiúsculas)
                const normalizarTexto = (texto) => {
                    return texto
                        .toUpperCase()
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^A-Z0-9]/g, '');
                };
                
                const tipoItemNormalizado = normalizarTexto(tipoItem);
                const filtroNormalizado = normalizarTexto(filtroValue);
                
                // Mapeamento de variações para cada tipo
                const mapeamentos = {
                    'FRACIONADO': ['FRACIONADO', 'FRAC', 'FRACIONADA', 'FRACION'],
                    'DEDICADO': ['DEDICADO', 'DED', 'DEDICADA', 'DEDIC'],
                    'RETIRA': ['RETIRA', 'RET', 'CLIENTE', 'CLIENTE RETIRA', 'RETIRACLIENTE']
                };
                
                // Verificar se o filtro corresponde a um tipo principal
                for (const [tipoPrincipal, variacoes] of Object.entries(mapeamentos)) {
                    // Verificar se o filtro é uma variação deste tipo
                    const filtroCorrespondeTipo = variacoes.some(variacao => 
                        filtroNormalizado.includes(normalizarTexto(variacao)) ||
                        normalizarTexto(variacao).includes(filtroNormalizado)
                    );
                    
                    if (filtroCorrespondeTipo) {
                        // Verificar se o item corresponde ao mesmo tipo
                        const itemCorrespondeTipo = variacoes.some(variacao => 
                            tipoItemNormalizado.includes(normalizarTexto(variacao)) ||
                            normalizarTexto(variacao).includes(tipoItemNormalizado)
                        );
                        
                        return itemCorrespondeTipo;
                    }
                }
                
                // Se chegou aqui, fazer uma comparação direta
                return tipoItemNormalizado.includes(filtroNormalizado) || 
                       filtroNormalizado.includes(tipoItemNormalizado);
            }

            aplicarFiltrosExpedicao(dados) {
                if (!dados) return [];
                
                return dados.filter(item => {
                    // 1. Filtro por número do pedido
                    if (this.elements.numeroPedido.value) {
                        const pedidosBusca = this.elements.numeroPedido.value.split(',').map(p => p.trim());
                        const pedidoItem = (item.PEDIDOS || '').toString();
                        if (!pedidosBusca.some(pedido => pedidoItem.includes(pedido))) {
                            return false;
                        }
                    }
                    
                    // 2. Filtro por cliente
                    if (this.elements.clienteExpedicao.value) {
                        const clienteBusca = this.elements.clienteExpedicao.value.toLowerCase();
                        const clienteItem = (item.CLIENTE || '').toLowerCase();
                        if (!clienteItem.includes(clienteBusca)) {
                            return false;
                        }
                    }
                    
                    // 3. Filtro por transportadora
                    if (this.elements.transportadoraExpedicao.value) {
                        const transportadoraItem = (item.TRANSPORTADORA || '').toString().trim();
                        const transportadoraFiltro = this.elements.transportadoraExpedicao.value.trim();
                        if (transportadoraItem !== transportadoraFiltro) {
                            return false;
                        }
                    }
                    
                    // 4. Filtro por UF
                    if (this.elements.ufExpedicao.value) {
                        const ufItem = (item.UF || '').toString().trim();
                        const ufFiltro = this.elements.ufExpedicao.value.trim();
                        if (ufItem !== ufFiltro) {
                            return false;
                        }
                    }
                    
                    // 5. Filtro por data de carregamento
                    if (this.elements.dataCarregamentoInicio.value || this.elements.dataCarregamentoFim.value) {
                        const dataCarregamentoItem = item.DATA_CARREG_COMPLETA || item['DATA CARREGAMENTO'] || '';
                        const dataItem = this.extrairDataItem(dataCarregamentoItem);
                        if (!dataItem) {
                            return false;
                        }
                        
                        if (this.elements.dataCarregamentoInicio.value) {
                            const dataInicio = this.converterDataFiltro(this.elements.dataCarregamentoInicio.value);
                            if (!dataInicio) return false;
                            if (dataItem.timestamp < dataInicio.timestamp) {
                                return false;
                            }
                        }
                        
                        if (this.elements.dataCarregamentoFim.value) {
                            const dataFim = this.converterDataFiltro(this.elements.dataCarregamentoFim.value);
                            if (!dataFim) return false;
                            if (dataItem.timestamp > dataFim.timestamp) {
                                return false;
                            }
                        }
                    }
                    
                    // 6. Filtro por status de erro
                    if (this.elements.statusErroExpedicao.value === 'com_erro' && !item.TEM_ERRO) {
                        return false;
                    }
                    if (this.elements.statusErroExpedicao.value === 'sem_erro' && item.TEM_ERRO) {
                        return false;
                    }
                    
                    // 7. Filtro por tipo de erro
                    if (this.elements.tipoErroExpedicao.value) {
                        const erroItem = (item.ERRO_DETALHE || '').toString().trim();
                        const erroFiltro = this.elements.tipoErroExpedicao.value.trim();
                        if (erroItem !== erroFiltro) {
                            return false;
                        }
                    }
                    
                    // 8. Filtro por status de atraso - NOVO FILTRO
                    if (this.elements.statusAtrasoExpedicao && this.elements.statusAtrasoExpedicao.value) {
                        const tipoAtrasoItem = item.TIPO_ATRASO || '';
                        
                        switch(this.elements.statusAtrasoExpedicao.value) {
                            case 'atraso_transportadora':
                                if (tipoAtrasoItem !== 'ATRASO TRANSPORTADORA') return false;
                                break;
                            case 'atraso_expedicao':
                                if (tipoAtrasoItem !== 'ATRASO EXPEDIÇÃO') return false;
                                break;
                            case 'no_prazo':
                                if (tipoAtrasoItem !== 'NO PRAZO') return false;
                                break;
                            case 'sem_dados':
                                if (tipoAtrasoItem !== 'SEM DADOS') return false;
                                break;
                        }
                    }
                    
                    // 9. Filtro por tipo de carregamento - CORREÇÃO APLICADA
                    if (this.elements.tipoCarregamentoExpedicao && this.elements.tipoCarregamentoExpedicao.value !== undefined) {
                        const filtroValue = this.elements.tipoCarregamentoExpedicao.value;
                        if (!this.aplicarFiltroTipoCarregamento(item, filtroValue, 'TIPO_CARREGAMENTO')) {
                            return false;
                        }
                    }
                    
                    // Filtros avançados
                    if (this.elements.paletesMin.value && item.PALETES < parseFloat(this.elements.paletesMin.value)) {
                        return false;
                    }
                    if (this.elements.paletesMax.value && item.PALETES > parseFloat(this.elements.paletesMax.value)) {
                        return false;
                    }
                    
                    if (this.elements.leadTimeMin.value && item.LEAD_TIME < parseFloat(this.elements.leadTimeMin.value)) {
                        return false;
                    }
                    if (this.elements.leadTimeMax.value && item.LEAD_TIME > parseFloat(this.elements.leadTimeMax.value)) {
                        return false;
                    }
                    
                    if (this.elements.tempoSeparacaoMin.value && item.TEMPO_SEPARACAO < parseFloat(this.elements.tempoSeparacaoMin.value)) {
                        return false;
                    }
                    if (this.elements.tempoSeparacaoMax.value && item.TEMPO_SEPARACAO > parseFloat(this.elements.tempoSeparacaoMax.value)) {
                        return false;
                    }
                    
                    if (this.elements.cidadeExpedicao.value) {
                        const cidadeItem = (item.CIDADE || '').toString().trim();
                        const cidadeFiltro = this.elements.cidadeExpedicao.value.trim();
                        if (cidadeItem !== cidadeFiltro) {
                            return false;
                        }
                    }
                    
                    if (this.elements.notaFiscalExpedicao.value) {
                        const notaItem = (item['NOTA FISCAL'] || '').toString();
                        const notaFiltro = this.elements.notaFiscalExpedicao.value;
                        if (!notaItem.includes(notaFiltro)) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }

            aplicarFiltrosRecebimento(dados) {
                if (!dados) return [];
                
                return dados.filter(item => {
                    if (this.elements.numeroNota.value) {
                        const notasBusca = this.elements.numeroNota.value.split(',').map(n => n.trim());
                        const notaItem = (item.NF || '').toString();
                        if (!notasBusca.some(nota => notaItem.includes(nota))) {
                            return false;
                        }
                    }
                    
                    if (this.elements.clienteRecebimento.value) {
                        const clienteBusca = this.elements.clienteRecebimento.value.toLowerCase();
                        const clienteItem = (item['CLIENTE/FILIAL'] || '').toLowerCase();
                        if (!clienteItem.includes(clienteBusca)) {
                            return false;
                        }
                    }
                    
                    if (this.elements.transportadoraRecebimento.value) {
                        const transportadoraItem = (item.TRANSPORTADORA || '').toString().trim();
                        const transportadoraFiltro = this.elements.transportadoraRecebimento.value.trim();
                        if (transportadoraItem !== transportadoraFiltro) {
                            return false;
                        }
                    }
                    
                    // Filtro por data de recebimento
                    if (this.elements.dataRecebimentoInicio.value || this.elements.dataRecebimentoFim.value) {
                        const dataRecebimentoItem = item['DATA DE RECEBIMENTO'] || item['DATA RECEBIMENTO'] || '';
                        const dataItem = this.extrairDataItem(dataRecebimentoItem);
                        if (!dataItem) {
                            return false;
                        }
                        
                        if (this.elements.dataRecebimentoInicio.value) {
                            const dataInicio = this.converterDataFiltro(this.elements.dataRecebimentoInicio.value);
                            if (!dataInicio) return false;
                            if (dataItem.timestamp < dataInicio.timestamp) {
                                return false;
                            }
                        }
                        
                        if (this.elements.dataRecebimentoFim.value) {
                            const dataFim = this.converterDataFiltro(this.elements.dataRecebimentoFim.value);
                            if (!dataFim) return false;
                            if (dataItem.timestamp > dataFim.timestamp) {
                                return false;
                            }
                        }
                    }
                    
                    // Filtro por data de lançamento
                    if (this.elements.dataLancamentoInicio.value || this.elements.dataLancamentoFim.value) {
                        const dataLancamentoItem = item['DATA LANÇAMENTO'] || '';
                        
                        if (!dataLancamentoItem || dataLancamentoItem.trim() === '') {
                            return false;
                        }
                        
                        const dataItem = this.extrairDataItem(dataLancamentoItem);
                        if (!dataItem) {
                            return false;
                        }
                        
                        if (this.elements.dataLancamentoInicio.value) {
                            const dataInicio = this.converterDataFiltro(this.elements.dataLancamentoInicio.value);
                            if (!dataInicio) return false;
                            if (dataItem.timestamp < dataInicio.timestamp) {
                                return false;
                            }
                        }
                        
                        if (this.elements.dataLancamentoFim.value) {
                            const dataFim = this.converterDataFiltro(this.elements.dataLancamentoFim.value);
                            if (!dataFim) return false;
                            if (dataItem.timestamp > dataFim.timestamp) {
                                return false;
                            }
                        }
                    }
                    
                    if (this.elements.armazemRecebimento.value) {
                        const armazemItem = (item.ARMAZEM || '').toString().trim();
                        const armazemFiltro = this.elements.armazemRecebimento.value.trim();
                        if (armazemItem !== armazemFiltro) {
                            return false;
                        }
                    }
                    
                    if (this.elements.statusLancamento.value === 'lancado' && !item['DATA LANÇAMENTO']) {
                        return false;
                    }
                    if (this.elements.statusLancamento.value === 'pendente' && item['DATA LANÇAMENTO']) {
                        return false;
                    }
                    
                    if (this.elements.statusErroRecebimento.value === 'com_erro' && !item.TEM_ERRO) {
                        return false;
                    }
                    if (this.elements.statusErroRecebimento.value === 'sem_erro' && item.TEM_ERRO) {
                        return false;
                    }
                    
                    return true;
                });
            }

            aplicarFiltrosEmAndamento(dados) {
                if (!dados) return [];
                
                return dados.filter(item => {
                    if (this.elements.pedidoAndamento.value) {
                        const pedidosBusca = this.elements.pedidoAndamento.value.split(',').map(p => p.trim());
                        const pedidoItem = (item.PEDIDOS || '').toString();
                        if (!pedidosBusca.some(pedido => pedidoItem.includes(pedido))) {
                            return false;
                        }
                    }
                    
                    if (this.elements.clienteAndamento.value) {
                        const clienteBusca = this.elements.clienteAndamento.value.toLowerCase();
                        const clienteItem = (item.CLIENTE || '').toLowerCase();
                        if (!clienteItem.includes(clienteBusca)) {
                            return false;
                        }
                    }
                    
                    if (this.elements.transportadoraAndamento.value) {
                        const transportadoraItem = (item.TRANSPORTADORA || '').toString().trim();
                        const transportadoraFiltro = this.elements.transportadoraAndamento.value.trim();
                        if (transportadoraItem !== transportadoraFiltro) {
                            return false;
                        }
                    }
                    
                    if (this.elements.ufAndamento.value) {
                        const ufItem = (item.UF || '').toString().trim();
                        const ufFiltro = this.elements.ufAndamento.value.trim();
                        if (ufItem !== ufFiltro) {
                            return false;
                        }
                    }
                    
                    if (this.elements.cidadeAndamento.value) {
                        const cidadeItem = (item.CIDADE || '').toString().trim();
                        const cidadeFiltro = this.elements.cidadeAndamento.value.trim();
                        if (cidadeItem !== cidadeFiltro) {
                            return false;
                        }
                    }
                    
                    if (this.elements.statusSeparacao && this.elements.statusSeparacao.value) {
                        const statusItem = item.STATUS_SEPARACAO || '';
                        
                        switch(this.elements.statusSeparacao.value) {
                            case 'em_separacao':
                                if (statusItem !== 'Em Separação') return false;
                                break;
                            case 'falta_separacao':
                                if (statusItem !== 'Falta Separação') return false;
                                break;
                            case 'separado':
                                if (statusItem !== 'Separado') return false;
                                break;
                        }
                    }
                    
                    // Filtro por tipo de carregamento (Em Andamento) - CORREÇÃO APLICADA
                    if (this.elements.tipoCarregamentoAndamento && this.elements.tipoCarregamentoAndamento.value !== undefined) {
                        const filtroValue = this.elements.tipoCarregamentoAndamento.value;
                        if (!this.aplicarFiltroTipoCarregamento(item, filtroValue, 'TIPO_CARREGAMENTO')) {
                            return false;
                        }
                    }
                    
                    return true;
                });
            }

            preencherFiltros(dadosExpedicao, dadosRecebimento, dadosEmAndamento) {
                this.preencherTransportadoras(dadosExpedicao, 'transportadoraExpedicao');
                this.preencherTransportadoras(dadosRecebimento, 'transportadoraRecebimento');
                this.preencherTransportadoras(dadosEmAndamento, 'transportadoraAndamento');
                
                this.preencherEstados(dadosExpedicao, 'ufExpedicao');
                this.preencherEstados(dadosEmAndamento, 'ufAndamento');
                
                this.preencherCidades(dadosExpedicao, 'cidadeExpedicao');
                this.preencherCidades(dadosEmAndamento, 'cidadeAndamento');
                
                this.preencherArmazens(dadosRecebimento, 'armazemRecebimento');
                this.preencherTiposErro(dadosExpedicao, 'tipoErroExpedicao');
                
                // ADICIONADO: Preencher tipos de carregamento - CORREÇÃO APLICADA
                this.preencherTiposCarregamento(dadosExpedicao, 'tipoCarregamentoExpedicao');
                this.preencherTiposCarregamento(dadosEmAndamento, 'tipoCarregamentoAndamento');
            }

            preencherTransportadoras(dados, selectId) {
                const transportadoras = new Set();
                dados.forEach(item => {
                    if (item.TRANSPORTADORA && item.TRANSPORTADORA.trim() !== '') {
                        transportadoras.add(item.TRANSPORTADORA.trim());
                    }
                });
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">Todas</option>';
                Array.from(transportadoras).sort().forEach(transp => {
                    const option = document.createElement('option');
                    option.value = transp;
                    option.textContent = transp;
                    select.appendChild(option);
                });
                if (currentValue) {
                    select.value = currentValue;
                }
            }

            preencherEstados(dados, selectId) {
                const estados = new Set();
                dados.forEach(item => {
                    if (item.UF && item.UF.trim() !== '') {
                        estados.add(item.UF.trim());
                    }
                });
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">Todas</option>';
                Array.from(estados).sort().forEach(uf => {
                    const option = document.createElement('option');
                    option.value = uf;
                    option.textContent = uf;
                    select.appendChild(option);
                });
                if (currentValue) {
                    select.value = currentValue;
                }
            }

            preencherCidades(dados, selectId) {
                const cidades = new Set();
                dados.forEach(item => {
                    if (item.CIDADE && item.CIDADE.trim() !== '') {
                        cidades.add(item.CIDADE.trim());
                    }
                });
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">Todas</option>';
                Array.from(cidades).sort().forEach(cidade => {
                    const option = document.createElement('option');
                    option.value = cidade;
                    option.textContent = cidade;
                    select.appendChild(option);
                });
                if (currentValue) {
                    select.value = currentValue;
                }
            }

            preencherArmazens(dados, selectId) {
                const armazens = new Set();
                dados.forEach(item => {
                    if (item.ARMAZEM && item.ARMAZEM.trim() !== '') {
                        armazens.add(item.ARMAZEM.trim());
                    }
                });
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">Todos</option>';
                Array.from(armazens).sort().forEach(armazem => {
                    const option = document.createElement('option');
                    option.value = armazem;
                    option.textContent = armazem;
                    select.appendChild(option);
                });
                if (currentValue) {
                    select.value = currentValue;
                }
            }

            preencherTiposErro(dados, selectId) {
                const tiposErro = new Set();
                dados.forEach(item => {
                    if (item.ERRO_DETALHE && item.ERRO_DETALHE.trim() !== '') {
                        tiposErro.add(item.ERRO_DETALHE.trim());
                    }
                });
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                select.innerHTML = '<option value="">Todos</option>';
                Array.from(tiposErro).sort().forEach(erro => {
                    const option = document.createElement('option');
                    option.value = erro;
                    option.textContent = erro;
                    select.appendChild(option);
                });
                if (currentValue) {
                    select.value = currentValue;
                }
            }

            resetarFiltros() {
                Object.values(this.elements).forEach(element => {
                    if (element) {
                        element.value = '';
                    }
                });
                
                ['transportadoraExpedicao', 'ufExpedicao', 'tipoErroExpedicao', 
                 'cidadeExpedicao', 'transportadoraRecebimento', 'armazemRecebimento',
                 'transportadoraAndamento', 'ufAndamento', 'cidadeAndamento', 'statusSeparacao',
                 'tipoCarregamentoExpedicao', 'tipoCarregamentoAndamento'].forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '<option value="">Todas</option>';
                    }
                });
                
                if (this.advancedFiltersVisible) {
                    this.toggleAdvancedFilters();
                }
                
                localStorage.removeItem('filtrosExpedicao');
                localStorage.removeItem('filtrosRecebimento');
                localStorage.removeItem('filtrosEmAndamento');
                
                setTimeout(() => dashboardApp.aplicarFiltros(), 100);
            }

            mostrarResultados(quantidade) {
                const resultsDiv = document.getElementById('filterResults');
                const resultsCount = document.getElementById('resultsCount');
                
                if (resultsDiv && resultsCount) {
                    resultsCount.textContent = quantidade.toLocaleString('pt-BR');
                    resultsDiv.style.display = 'flex';
                }
            }

            ocultarResultados() {
                const resultsDiv = document.getElementById('filterResults');
                if (resultsDiv) {
                    resultsDiv.style.display = 'none';
                }
            }
            
            // Nova função para obter informações do cache
            getCacheInfo(filialId) {
                const cacheKeys = ['expedicao', 'recebimento', 'emandamento'];
                let earliestExpiry = Infinity;
                let hasCache = false;
                
                cacheKeys.forEach(tipo => {
                    const cacheKey = `${CONFIG.CACHE_KEY_PREFIX}${filialId}_${tipo}`;
                    const cacheItem = localStorage.getItem(cacheKey);
                    
                    if (cacheItem) {
                        hasCache = true;
                        try {
                            const cacheData = JSON.parse(cacheItem);
                            if (cacheData.expiry < earliestExpiry) {
                                earliestExpiry = cacheData.expiry;
                            }
                        } catch (error) {
                            console.warn('Erro ao analisar cache:', error);
                        }
                    }
                });
                
                return {
                    hasCache,
                    earliestExpiry,
                    timeUntilExpiry: earliestExpiry !== Infinity ? earliestExpiry - Date.now() : 0
                };
            }
        }

        const filterManager = new FilterManager();

        // Pagination Manager
        class PaginationManager {
            constructor() {
                this.currentPage = 1;
                this.itemsPerPage = 50;
                this.filteredData = [];
                this.currentTab = 'expedicao';
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Event listeners para expedição (top e bottom)
                ['top', 'bottom'].forEach(position => {
                    const itemsPerPageId = `itemsPerPage-${position}-expedicao`;
                    const currentPageId = `currentPage-${position}-expedicao`;
                    const itemsPerPageElement = document.getElementById(itemsPerPageId);
                    const currentPageElement = document.getElementById(currentPageId);
                    
                    if (itemsPerPageElement) {
                        itemsPerPageElement.addEventListener('change', (e) => {
                            // Sincronizar ambos os selects
                            document.getElementById(`itemsPerPage-top-expedicao`).value = e.target.value;
                            document.getElementById(`itemsPerPage-bottom-expedicao`).value = e.target.value;
                            
                            this.itemsPerPage = parseInt(e.target.value);
                            this.currentPage = 1;
                            dashboardApp.aplicarFiltros();
                        });
                    }
                    
                    if (currentPageElement) {
                        currentPageElement.addEventListener('change', (e) => {
                            const page = parseInt(e.target.value);
                            const totalPages = this.getTotalPages();
                            
                            if (page >= 1 && page <= totalPages) {
                                this.currentPage = page;
                                // Sincronizar ambos os inputs
                                document.getElementById(`currentPage-top-expedicao`).value = page;
                                document.getElementById(`currentPage-bottom-expedicao`).value = page;
                                this.renderCurrentPage();
                            } else {
                                e.target.value = this.currentPage;
                            }
                        });
                        
                        currentPageElement.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.target.blur();
                            }
                        });
                    }
                });
                
                // Adicionar botões de navegação para expedição
                this.addNavigationButtons('expedicao');
                
                // Event listeners para recebimento (top e bottom)
                ['top', 'bottom'].forEach(position => {
                    const itemsPerPageId = `itemsPerPage-${position}-recebimento`;
                    const currentPageId = `currentPage-${position}-recebimento`;
                    const itemsPerPageElement = document.getElementById(itemsPerPageId);
                    const currentPageElement = document.getElementById(currentPageId);
                    
                    if (itemsPerPageElement) {
                        itemsPerPageElement.addEventListener('change', (e) => {
                            // Sincronizar ambos os selects
                            document.getElementById(`itemsPerPage-top-recebimento`).value = e.target.value;
                            document.getElementById(`itemsPerPage-bottom-recebimento`).value = e.target.value;
                            
                            this.itemsPerPage = parseInt(e.target.value);
                            this.currentPage = 1;
                            dashboardApp.aplicarFiltros();
                        });
                    }
                    
                    if (currentPageElement) {
                        currentPageElement.addEventListener('change', (e) => {
                            const page = parseInt(e.target.value);
                            const totalPages = this.getTotalPages();
                            
                            if (page >= 1 && page <= totalPages) {
                                this.currentPage = page;
                                // Sincronizar ambos os inputs
                                document.getElementById(`currentPage-top-recebimento`).value = page;
                                document.getElementById(`currentPage-bottom-recebimento`).value = page;
                                this.renderCurrentPage();
                            } else {
                                e.target.value = this.currentPage;
                            }
                        });
                        
                        currentPageElement.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.target.blur();
                            }
                        });
                    }
                });
                
                this.addNavigationButtons('recebimento');
                
                // Event listeners para em andamento (top e bottom)
                ['top', 'bottom'].forEach(position => {
                    const itemsPerPageId = `itemsPerPage-${position}-emandamento`;
                    const currentPageId = `currentPage-${position}-emandamento`;
                    const itemsPerPageElement = document.getElementById(itemsPerPageId);
                    const currentPageElement = document.getElementById(currentPageId);
                    
                    if (itemsPerPageElement) {
                        itemsPerPageElement.addEventListener('change', (e) => {
                            // Sincronizar ambos os selects
                            document.getElementById(`itemsPerPage-top-emandamento`).value = e.target.value;
                            document.getElementById(`itemsPerPage-bottom-emandamento`).value = e.target.value;
                            
                            this.itemsPerPage = parseInt(e.target.value);
                            this.currentPage = 1;
                            dashboardApp.aplicarFiltros();
                        });
                    }
                    
                    if (currentPageElement) {
                        currentPageElement.addEventListener('change', (e) => {
                            const page = parseInt(e.target.value);
                            const totalPages = this.getTotalPages();
                            
                            if (page >= 1 && page <= totalPages) {
                                this.currentPage = page;
                                // Sincronizar ambos os inputs
                                document.getElementById(`currentPage-top-emandamento`).value = page;
                                document.getElementById(`currentPage-bottom-emandamento`).value = page;
                                this.renderCurrentPage();
                            } else {
                                e.target.value = this.currentPage;
                            }
                        });
                        
                        currentPageElement.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter') {
                                e.target.blur();
                            }
                        });
                    }
                });
                
                this.addNavigationButtons('emandamento');
            }

            addNavigationButtons(tab) {
                // Adicionar listeners para botões top e bottom
                ['top', 'bottom'].forEach(position => {
                    const container = document.getElementById(`pagination-${position}-${tab}`);
                    if (!container) return;

                    // Botão primeira página
                    const firstBtn = container.querySelector('.first-page-' + position);
                    if (firstBtn) {
                        firstBtn.addEventListener('click', () => {
                            this.currentPage = 1;
                            this.renderCurrentPage();
                        });
                    }

                    // Botão página anterior
                    const prevBtn = container.querySelector('.prev-page-' + position);
                    if (prevBtn) {
                        prevBtn.addEventListener('click', () => {
                            if (this.currentPage > 1) {
                                this.currentPage--;
                                this.renderCurrentPage();
                            }
                        });
                    }

                    // Botão próxima página
                    const nextBtn = container.querySelector('.next-page-' + position);
                    if (nextBtn) {
                        nextBtn.addEventListener('click', () => {
                            const totalPages = this.getTotalPages();
                            if (this.currentPage < totalPages) {
                                this.currentPage++;
                                this.renderCurrentPage();
                            }
                        });
                    }

                    // Botão última página
                    const lastBtn = container.querySelector('.last-page-' + position);
                    if (lastBtn) {
                        lastBtn.addEventListener('click', () => {
                            const totalPages = this.getTotalPages();
                            this.currentPage = totalPages;
                            this.renderCurrentPage();
                        });
                    }
                });
            }

            setData(data, tab) {
                this.filteredData = data;
                this.currentTab = tab;
                this.currentPage = 1;
                this.updatePaginationInfo();
                this.renderCurrentPage();
            }

            getTotalPages() {
                return Math.ceil(this.filteredData.length / this.itemsPerPage);
            }

            getCurrentPageData() {
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                return this.filteredData.slice(startIndex, endIndex);
            }

            updatePaginationInfo() {
                const totalPages = this.getTotalPages();
                const start = Math.min((this.currentPage - 1) * this.itemsPerPage + 1, this.filteredData.length);
                const end = Math.min(this.currentPage * this.itemsPerPage, this.filteredData.length);
                
                // Atualizar para a aba atual (top e bottom)
                ['top', 'bottom'].forEach(position => {
                    const startElement = document.getElementById(`start-${position}-${this.currentTab}`);
                    const endElement = document.getElementById(`end-${position}-${this.currentTab}`);
                    const totalElement = document.getElementById(`total-${position}-${this.currentTab}`);
                    const totalPagesElement = document.getElementById(`totalPages-${position}-${this.currentTab}`);
                    const currentPageElementTop = document.getElementById(`currentPage-top-${this.currentTab}`);
                    const currentPageElementBottom = document.getElementById(`currentPage-bottom-${this.currentTab}`);
                    
                    if (startElement) startElement.textContent = start.toLocaleString('pt-BR');
                    if (endElement) endElement.textContent = end.toLocaleString('pt-BR');
                    if (totalElement) totalElement.textContent = this.filteredData.length.toLocaleString('pt-BR');
                    if (totalPagesElement) totalPagesElement.textContent = totalPages.toLocaleString('pt-BR');
                    
                    // Sincronizar inputs de página
                    if (currentPageElementTop) currentPageElementTop.value = this.currentPage;
                    if (currentPageElementBottom) currentPageElementBottom.value = this.currentPage;
                    
                    // Mostrar container de paginação
                    const paginationContainer = document.getElementById(`pagination-${position}-${this.currentTab}`);
                    if (paginationContainer) {
                        paginationContainer.style.display = 'flex';
                    }
                });
            }

            renderCurrentPage() {
                const pageData = this.getCurrentPageData();
                
                switch(this.currentTab) {
                    case 'expedicao':
                        tableManager.renderizarExpedicao(pageData);
                        break;
                    case 'recebimento':
                        tableManager.renderizarRecebimento(pageData);
                        break;
                    case 'emandamento':
                        tableManager.renderizarEmAndamento(pageData);
                        break;
                }
                
                this.updatePaginationInfo();
                this.updateButtonStates();
            }

            updateButtonStates() {
                const totalPages = this.getTotalPages();
                const tab = this.currentTab;
                
                // Atualizar botões top e bottom
                ['top', 'bottom'].forEach(position => {
                    const firstBtn = document.querySelector(`#pagination-${position}-${tab} .first-page-${position}`);
                    const prevBtn = document.querySelector(`#pagination-${position}-${tab} .prev-page-${position}`);
                    const nextBtn = document.querySelector(`#pagination-${position}-${tab} .next-page-${position}`);
                    const lastBtn = document.querySelector(`#pagination-${position}-${tab} .last-page-${position}`);
                    
                    if (firstBtn && prevBtn) {
                        const disabled = this.currentPage === 1;
                        firstBtn.disabled = disabled;
                        prevBtn.disabled = disabled;
                        firstBtn.style.opacity = disabled ? '0.5' : '1';
                        prevBtn.style.opacity = disabled ? '0.5' : '1';
                    }
                    
                    if (nextBtn && lastBtn) {
                        const disabled = this.currentPage === totalPages;
                        nextBtn.disabled = disabled;
                        lastBtn.disabled = disabled;
                        nextBtn.style.opacity = disabled ? '0.5' : '1';
                        lastBtn.style.opacity = disabled ? '0.5' : '1';
                    }
                });
            }
        }

        const pagination = new PaginationManager();

        // Main App atualizada com sistema de cache e atualização automática
        class DashboardApp {
            constructor() {
                this.dados = { expedicao: [], recebimento: [], emandamento: [] };
                this.filialAtual = null;
                this.filialNome = '';
                this.autoRefreshInterval = null;
                this.cacheUpdateInterval = null;
                this.lastRefreshTime = null;
                this.pagination = pagination;
                this.init();
            }

            async init() {
                try {
                    await this.carregarFiliais();
                    this.configurarEventos();
                    this.pagination.init();
                    
                    // Configurar verificação periódica do cache
                    this.iniciarVerificacaoCache();
                    
                    // Tentar carregar última filial selecionada do localStorage
                    const ultimaFilial = localStorage.getItem('ultimaFilial');
                    if (ultimaFilial) {
                        const select = document.getElementById('filialSelect');
                        const option = select.querySelector(`option[value="${ultimaFilial}"]`);
                        if (option) {
                            select.value = ultimaFilial;
                            select.dispatchEvent(new Event('change'));
                        }
                    }
                } catch (error) {
                    this.mostrarErro('Erro ao inicializar: ' + error.message);
                }
            }

            async carregarFiliais() {
                const filiais = await apiService.carregarFiliais();
                const select = document.getElementById('filialSelect');
                select.innerHTML = '<option value="">Selecione uma filial</option>';
                select.innerHTML += '<option value="TODAS">TODAS AS FILIAIS</option>';
                filiais.forEach(filial => {
                    const option = document.createElement('option');
                    option.value = filial.id;
                    option.textContent = filial.nome;
                    option.dataset.nome = filial.nome;
                    select.appendChild(option);
                });
            }

            configurarEventos() {
                document.getElementById('filialSelect').addEventListener('change', (e) => {
                    if (e.target.value) {
                        this.filialAtual = e.target.value;
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        this.filialNome = selectedOption.dataset.nome || selectedOption.textContent;
                        
                        // Salvar última filial selecionada
                        localStorage.setItem('ultimaFilial', this.filialAtual);
                        
                        this.atualizarTituloFilial();
                        this.carregarDadosFilial(e.target.value, false); // Não forçar atualização inicial
                        this.atualizarIndicadorCache();
                        
                        setTimeout(() => {
                            filterManager.resetarFiltros();
                        }, 500);
                    } else {
                        this.filialNome = '';
                        this.atualizarTituloFilial();
                        this.pararAutoRefresh();
                        this.limparTabelas();
                        this.ocultarIndicadorCache();
                    }
                });

                document.querySelectorAll('.tab-btn').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        this.mudarTab(e.target.getAttribute('data-tab'));
                    });
                });

                document.getElementById('applyFilters').addEventListener('click', () => {
                    this.aplicarFiltros();
                });

                document.getElementById('resetFilters').addEventListener('click', () => {
                    filterManager.resetarFiltros();
                });

                document.getElementById('exportExpedicao').addEventListener('click', () => {
                    this.exportarCSV(this.getDadosFiltradosPorTipo('expedicao'), 'expedicao');
                });

                document.getElementById('exportRecebimento').addEventListener('click', () => {
                    this.exportarCSV(this.getDadosFiltradosPorTipo('recebimento'), 'recebimento');
                });

                document.getElementById('exportEmAndamento').addEventListener('click', () => {
                    this.exportarCSV(this.getDadosFiltradosPorTipo('emandamento'), 'emandamento');
                });

                // Botão de refresh atualizado
                document.getElementById('refreshData').addEventListener('click', () => {
                    if (this.filialAtual) {
                        this.atualizarDadosForcadamente();
                    }
                });

                document.getElementById('toggleAdvancedFilters').addEventListener('click', () => {
                    filterManager.toggleAdvancedFilters();
                });
            }

            atualizarTituloFilial() {
                const filialNameElement = document.getElementById('currentFilialName');
                
                if (this.filialNome) {
                    if (this.filialAtual === 'TODAS') {
                        filialNameElement.textContent = 'TODAS AS FILIAIS';
                        filialNameElement.className = 'filial-name todas';
                    } else {
                        filialNameElement.textContent = this.filialNome;
                        filialNameElement.className = 'filial-name';
                    }
                } else {
                    filialNameElement.textContent = 'Nenhuma filial selecionada';
                    filialNameElement.className = 'filial-name';
                }
            }

            async carregarDadosFilial(filialId, forcarAtualizacao = false) {
                try {
                    this.mostrarLoading();
                    
                    // Adicionar efeito visual no botão de refresh
                    this.animarBotaoRefresh();
                    
                    // Mostrar indicador de atualização
                    this.mostrarIndicadorAtualizacao();
                    
                    const [expedicao, recebimento, emandamento] = await Promise.allSettled([
                        apiService.carregarDadosExpedicao(filialId, forcarAtualizacao),
                        apiService.carregarDadosRecebimento(filialId, forcarAtualizacao),
                        apiService.carregarDadosEmAndamento(filialId, forcarAtualizacao)
                    ]);

                    this.dados.expedicao = expedicao.status === 'fulfilled' ? expedicao.value : [];
                    this.dados.recebimento = recebimento.status === 'fulfilled' ? recebimento.value : [];
                    this.dados.emandamento = emandamento.status === 'fulfilled' ? emandamento.value : [];

                    console.log('Dados carregados:');
                    console.log('- Expedição:', this.dados.expedicao.length);
                    console.log('- Recebimento:', this.dados.recebimento.length);
                    console.log('- Em Andamento:', this.dados.emandamento.length);

                    if (expedicao.status === 'rejected') {
                        this.mostrarErroExpedicao('Erro ao carregar expedição: ' + expedicao.reason.message);
                    }
                    if (recebimento.status === 'rejected') {
                        this.mostrarErroRecebimento('Erro ao carregar recebimento: ' + recebimento.reason.message);
                    }
                    if (emandamento.status === 'rejected') {
                        this.mostrarErroEmAndamento('Erro ao carregar dados em andamento: ' + emandamento.reason.message);
                    }

                    this.lastRefreshTime = Date.now();
                    this.processarDadosCarregados();
                    
                    // Atualizar indicador de cache
                    this.atualizarIndicadorCache();
                    
                    // Mostrar notificação se foi carregado do cache
                    if (!forcarAtualizacao) {
                        const cacheInfo = filterManager.getCacheInfo(filialId);
                        if (cacheInfo.hasCache) {
                            this.mostrarNotificacaoCache();
                        }
                    }
                } catch (error) {
                    this.mostrarErro('Erro ao carregar dados: ' + error.message);
                } finally {
                    this.ocultarLoading();
                    // Remover animação do botão
                    this.removerAnimacaoBotaoRefresh();
                    // Ocultar indicador de atualização
                    this.ocultarIndicadorAtualizacao();
                }
            }

            async atualizarDadosForcadamente() {
                if (!this.filialAtual) return;
                
                // Limpar cache local antes de buscar novos dados
                apiService.limparCacheLocal(this.filialAtual);
                
                // Forçar atualização
                await this.carregarDadosFilial(this.filialAtual, true);
                
                // Mostrar notificação de atualização
                this.mostrarNotificacaoSucesso('Dados atualizados com sucesso!');
            }

            processarDadosCarregados() {
                filterManager.preencherFiltros(
                    this.dados.expedicao, 
                    this.dados.recebimento, 
                    this.dados.emandamento
                );
                
                this.atualizarKPIsExpedicao(this.dados.expedicao);
                this.atualizarKPIsRecebimento(this.dados.recebimento);
                this.atualizarKPIsEmAndamento(this.dados.emandamento);
                
                this.aplicarFiltros();
            }

            atualizarKPIsExpedicao(dados) {
                const totalPedidos = dados.length;
                const errosExpedicao = dados.filter(item => item.TEM_ERRO).length;
                const taxaErroExpedicao = totalPedidos > 0 ? ((errosExpedicao / totalPedidos) * 100).toFixed(1) : 0;
                
                const temposSeparacao = dados.filter(item => item.TEMPO_SEPARACAO > 0).map(item => item.TEMPO_SEPARACAO);
                const tempoMedioSeparacao = temposSeparacao.length > 0 ? 
                    (temposSeparacao.reduce((a, b) => a + b, 0) / temposSeparacao.length) : 0;
                
                // NOVA LÓGICA: Tempo médio de carregamento (chegada -> carregamento)
                const temposCarregamento = dados.filter(item => item.TEMPO_CARREGAMENTO > 0).map(item => item.TEMPO_CARREGAMENTO);
                const tempoMedioCarregamento = temposCarregamento.length > 0 ? 
                    (temposCarregamento.reduce((a, b) => a + b, 0) / temposCarregamento.length) : 0;
                
                const totalPaletes = dados.reduce((sum, item) => sum + (item.PALETES || 0), 0);
                
                const leadTimes = dados.filter(item => item.LEAD_TIME > 0).map(item => item.LEAD_TIME);
                const leadTimeMedio = leadTimes.length > 0 ? 
                    (leadTimes.reduce((a, b) => a + b, 0) / leadTimes.length) : 0;
                
                // *** NOVO CÁLCULO: Média da hora da OC Enviada ***
                const minutosOCEnviada = [];
                
                dados.forEach(item => {
                    const dataOC = Utils.buscarValorPorChaves(item, [
                        'DATA E HORA OC ENVIADA',
                        'DATA OC ENVIADA',
                        'OC ENVIADA',
                        'OC_ENVIADA',
                        'HORA OC ENviada'
                    ]);
                    
                    if (dataOC && dataOC.trim() !== '') {
                        const horaMinuto = Utils.extrairHoraMinuto(dataOC);
                        
                        if (horaMinuto.hora !== null && horaMinuto.minuto !== null) {
                            // Converter para minutos totais do dia (0-1440)
                            const minutosDoDia = (horaMinuto.hora * 60) + horaMinuto.minuto;
                            minutosOCEnviada.push(minutosDoDia);
                        }
                    }
                });
                
                let mediaHoraOC = '--:--';
                let tooltipInfo = '';
                
                if (minutosOCEnviada.length > 0) {
                    // Calcular média dos minutos
                    const somaMinutos = minutosOCEnviada.reduce((a, b) => a + b, 0);
                    const mediaMinutos = somaMinutos / minutosOCEnviada.length;
                    
                    // Converter minutos de volta para formato hora:minuto
                    const horas = Math.floor(mediaMinutos / 60);
                    const minutos = Math.round(mediaMinutos % 60);
                    
                    // Formatar para HH:MM
                    mediaHoraOC = `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
                    
                    // Preparar tooltip com estatísticas
                    const contagem = minutosOCEnviada.length;
                    const horaMin = minutosOCEnviada.length > 0 ? 
                        `${Math.floor(Math.min(...minutosOCEnviada) / 60).toString().padStart(2, '0')}:${Math.round(Math.min(...minutosOCEnviada) % 60).toString().padStart(2, '0')}` : '--:--';
                    const horaMax = minutosOCEnviada.length > 0 ? 
                        `${Math.floor(Math.max(...minutosOCEnviada) / 60).toString().padStart(2, '0')}:${Math.round(Math.max(...minutosOCEnviada) % 60).toString().padStart(2, '0')}` : '--:--';
                    
                    tooltipInfo = `Baseado em ${contagem} registros\nMínima: ${horaMin}\nMáxima: ${horaMax}`;
                }
                
                // NOVA LÓGICA de atrasos baseada no novo cálculo
                const atrasosTransportadora = dados.filter(item => item.TIPO_ATRASO === 'ATRASO TRANSPORTADORA').length;
                const atrasosExpedicao = dados.filter(item => item.TIPO_ATRASO === 'ATRASO EXPEDIÇÃO').length;
                const noPrazo = dados.filter(item => item.TIPO_ATRASO === 'NO PRAZO').length;
                const semDados = dados.filter(item => item.TIPO_ATRASO === 'SEM DADOS').length;
                
                // *** NOVOS KPIs PARA TIPO DE CARREGAMENTO - CORREÇÃO APLICADA ***
                const tipoFracionado = dados.filter(item => 
                    item.TIPO_CARREGAMENTO && 
                    item.TIPO_CARREGAMENTO.toString().toUpperCase().includes('FRACIONADO')
                ).length;
                
                const tipoDedicado = dados.filter(item => 
                    item.TIPO_CARREGAMENTO && 
                    item.TIPO_CARREGAMENTO.toString().toUpperCase().includes('DEDICADO')
                ).length;
                
                const tipoRetira = dados.filter(item => 
                    item.TIPO_CARREGAMENTO && 
                    item.TIPO_CARREGAMENTO.toString().toUpperCase().includes('RETIRA')
                ).length;
                
                const semTipoCarregamento = dados.filter(item => 
                    !item.TIPO_CARREGAMENTO || 
                    item.TIPO_CARREGAMENTO.toString().trim() === '' ||
                    !item.TIPO_CARREGAMENTO.toString().toUpperCase().match(/FRACIONADO|DEDICADO|RETIRA/)
                ).length;

                // Atualizar os KPIs existentes
                document.getElementById('totalPedidos').textContent = totalPedidos.toLocaleString('pt-BR');
                document.getElementById('taxaErroExpedicao').textContent = `${taxaErroExpedicao}%`;
                document.getElementById('tempoMedioSeparacao').textContent = Utils.formatarHorasMinutos(tempoMedioSeparacao);
                document.getElementById('tempoMedioExpedicao').textContent = Utils.formatarHorasMinutos(tempoMedioCarregamento);
                document.getElementById('leadTimeMedio').textContent = Utils.formatarHorasMinutos(leadTimeMedio);
                document.getElementById('totalPaletes').textContent = Utils.formatarNumero(totalPaletes, 2);
                document.getElementById('atrasosTransportadora').textContent = atrasosTransportadora.toLocaleString('pt-BR');
                document.getElementById('atrasosExpedicao').textContent = atrasosExpedicao.toLocaleString('pt-BR');
                
                // *** ATUALIZAR NOVO KPI ***
                const mediaHoraElement = document.getElementById('mediaHoraOCEnviada');
                mediaHoraElement.textContent = mediaHoraOC;
                if (tooltipInfo) {
                    mediaHoraElement.title = tooltipInfo;
                } else {
                    mediaHoraElement.removeAttribute('title');
                }
                
                // Atualizar os novos KPIs - COM VERIFICAÇÃO
                console.log('Contagem de tipos de carregamento:');
                console.log('- Fracionado:', tipoFracionado);
                console.log('- Dedicado:', tipoDedicado);
                console.log('- Retira:', tipoRetira);
                console.log('- Sem tipo:', semTipoCarregamento);
                console.log('- Total dados:', dados.length);
                
                document.getElementById('tipoFracionado').textContent = tipoFracionado.toLocaleString('pt-BR');
                document.getElementById('tipoDedicado').textContent = tipoDedicado.toLocaleString('pt-BR');
                document.getElementById('tipoRetira').textContent = tipoRetira.toLocaleString('pt-BR');
                
                // Adicionar tooltips com informações detalhadas
                const kpiFracionado = document.getElementById('tipoFracionado');
                kpiFracionado.title = `Fracionado: ${tipoFracionado}\n${totalPedidos > 0 ? ((tipoFracionado/totalPedidos)*100).toFixed(1) : 0}% do total`;
                
                const kpiDedicado = document.getElementById('tipoDedicado');
                kpiDedicado.title = `Dedicado: ${tipoDedicado}\n${totalPedidos > 0 ? ((tipoDedicado/totalPedidos)*100).toFixed(1) : 0}% do total`;
                
                const kpiRetira = document.getElementById('tipoRetira');
                kpiRetira.title = `Retira: ${tipoRetira}\n${totalPedidos > 0 ? ((tipoRetira/totalPedidos)*100).toFixed(1) : 0}% do total`;
            }

            atualizarKPIsRecebimento(dados) {
                const totalNotas = dados.length;
                const notasLancadas = dados.filter(item => item['DATA LANÇAMENTO']).length;
                const notasPendentes = totalNotas - notasLancadas;
                const errosRecebimento = dados.filter(item => item.TEM_ERRO).length;
                const taxaErroRecebimento = totalNotas > 0 ? ((errosRecebimento / totalNotas) * 100).toFixed(1) : 0;

                document.getElementById('totalNotas').textContent = totalNotas.toLocaleString('pt-BR');
                document.getElementById('notasLancadas').textContent = notasLancadas.toLocaleString('pt-BR');
                document.getElementById('notasPendentes').textContent = notasPendentes.toLocaleString('pt-BR');
                document.getElementById('taxaErroRecebimento').textContent = `${taxaErroRecebimento}%`;
            }

            atualizarKPIsEmAndamento(dados) {
                const totalAndamento = dados.length;
                const totalPaletesAndamento = dados.reduce((sum, item) => sum + (item.PALETES || 0), 0);
                const emSeparacaoCount = dados.filter(item => item.STATUS_SEPARACAO === 'Em Separação').length;
                const faltaSeparacaoCount = dados.filter(item => item.STATUS_SEPARACAO === 'Falta Separação').length;

                document.getElementById('totalAndamento').textContent = totalAndamento.toLocaleString('pt-BR');
                document.getElementById('paletesAndamento').textContent = Utils.formatarNumero(totalPaletesAndamento, 2);
                document.getElementById('emSeparacaoCount').textContent = emSeparacaoCount.toLocaleString('pt-BR');
                document.getElementById('faltaSeparacaoCount').textContent = faltaSeparacaoCount.toLocaleString('pt-BR');
            }

            aplicarFiltros() {
                const tabAtiva = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                let resultadosFiltrados = [];
                
                if (tabAtiva === 'expedicao') {
                    resultadosFiltrados = filterManager.aplicarFiltrosExpedicao(this.dados.expedicao);
                    this.pagination.setData(resultadosFiltrados, 'expedicao');
                    this.atualizarKPIsExpedicao(resultadosFiltrados);
                } else if (tabAtiva === 'recebimento') {
                    resultadosFiltrados = filterManager.aplicarFiltrosRecebimento(this.dados.recebimento);
                    this.pagination.setData(resultadosFiltrados, 'recebimento');
                    this.atualizarKPIsRecebimento(resultadosFiltrados);
                } else if (tabAtiva === 'emandamento') {
                    resultadosFiltrados = filterManager.aplicarFiltrosEmAndamento(this.dados.emandamento);
                    this.pagination.setData(resultadosFiltrados, 'emandamento');
                    this.atualizarKPIsEmAndamento(resultadosFiltrados);
                }
                
                filterManager.mostrarResultados(resultadosFiltrados.length);
            }

            getDadosFiltradosPorTipo(tipo) {
                switch(tipo) {
                    case 'expedicao':
                        return filterManager.aplicarFiltrosExpedicao(this.dados.expedicao);
                    case 'recebimento':
                        return filterManager.aplicarFiltrosRecebimento(this.dados.recebimento);
                    case 'emandamento':
                        return filterManager.aplicarFiltrosEmAndamento(this.dados.emandamento);
                    default:
                        return [];
                }
            }

            mudarTab(tabId) {
                document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
                document.getElementById(`${tabId}-content`).classList.add('active');

                switch(tabId) {
                    case 'expedicao':
                        document.getElementById('filtersTitle').textContent = 'Filtros de Expedição';
                        document.getElementById('filtersExpedicao').style.display = 'grid';
                        document.getElementById('filtersRecebimento').style.display = 'none';
                        document.getElementById('filtersEmAndamento').style.display = 'none';
                        document.getElementById('kpisExpedicao').style.display = 'grid';
                        document.getElementById('kpisRecebimento').style.display = 'none';
                        document.getElementById('kpisEmAndamento').style.display = 'none';
                        break;
                    case 'recebimento':
                        document.getElementById('filtersTitle').textContent = 'Filtros de Recebimento';
                        document.getElementById('filtersExpedicao').style.display = 'none';
                        document.getElementById('filtersRecebimento').style.display = 'grid';
                        document.getElementById('filtersEmAndamento').style.display = 'none';
                        document.getElementById('kpisExpedicao').style.display = 'none';
                        document.getElementById('kpisRecebimento').style.display = 'grid';
                        document.getElementById('kpisEmAndamento').style.display = 'none';
                        break;
                    case 'emandamento':
                        document.getElementById('filtersTitle').textContent = 'Filtros de Em Andamento';
                        document.getElementById('filtersExpedicao').style.display = 'none';
                        document.getElementById('filtersRecebimento').style.display = 'none';
                        document.getElementById('filtersEmAndamento').style.display = 'grid';
                        document.getElementById('kpisExpedicao').style.display = 'none';
                        document.getElementById('kpisRecebimento').style.display = 'none';
                        document.getElementById('kpisEmAndamento').style.display = 'grid';
                        break;
                }
                
                this.aplicarFiltros();
            }

            limparTabelas() {
                tableManager.renderizarExpedicao([]);
                tableManager.renderizarRecebimento([]);
                tableManager.renderizarEmAndamento([]);
                filterManager.ocultarResultados();
                
                // Ocultar paginação (top e bottom)
                ['expedicao', 'recebimento', 'emandamento'].forEach(tab => {
                    ['top', 'bottom'].forEach(position => {
                        const pagination = document.getElementById(`pagination-${position}-${tab}`);
                        if (pagination) {
                            pagination.style.display = 'none';
                        }
                    });
                });
            }

            iniciarVerificacaoCache() {
                // Verificar a cada minuto se precisa atualizar o cache
                this.cacheUpdateInterval = setInterval(() => {
                    if (this.filialAtual) {
                        this.verificarAtualizacaoCache();
                    }
                }, 60 * 1000); // 1 minuto
            }

            verificarAtualizacaoCache() {
                if (!this.filialAtual) return;
                
                const cacheInfo = filterManager.getCacheInfo(this.filialAtual);
                
                // Se o cache está prestes a expirar (menos de 5 minutos)
                if (cacheInfo.timeUntilExpiry > 0 && cacheInfo.timeUntilExpiry < 5 * 60 * 1000) {
                    // Mostrar badge no botão de refresh
                    this.mostrarBadgeAtualizacao();
                }
                
                // Si o cache expirou, atualizar silenciosamente
                if (cacheInfo.timeUntilExpiry <= 0) {
                    console.log('Cache expirado, atualizando dados...');
                    this.atualizarDadosForcadamente();
                }
            }

            animarBotaoRefresh() {
                const refreshBtn = document.getElementById('refreshData');
                refreshBtn.classList.add('pulse');
                refreshBtn.disabled = true;
            }

            removerAnimacaoBotaoRefresh() {
                const refreshBtn = document.getElementById('refreshData');
                refreshBtn.classList.remove('pulse');
                refreshBtn.disabled = false;
            }

            mostrarBadgeAtualizacao() {
                const refreshBadge = document.getElementById('refreshBadge');
                refreshBadge.textContent = '!';
                refreshBadge.classList.remove('hidden');
                
                // Adicionar tooltip
                const refreshBtn = document.getElementById('refreshData');
                refreshBtn.title = 'Dados locais expiram em breve. Clique para atualizar.';
            }

            ocultarBadgeAtualizacao() {
                const refreshBadge = document.getElementById('refreshBadge');
                refreshBadge.classList.add('hidden');
                
                // Remover tooltip
                const refreshBtn = document.getElementById('refreshData');
                refreshBtn.title = 'Atualizar dados manualmente (dados locais são usados por 30 min)';
            }

            // NOVAS FUNÇÕES: Mostrar/ocultar indicador de atualização
            mostrarIndicadorAtualizacao() {
                const updateIndicator = document.getElementById('updateIndicator');
                if (updateIndicator) {
                    updateIndicator.style.display = 'flex';
                }
            }

            ocultarIndicadorAtualizacao() {
                const updateIndicator = document.getElementById('updateIndicator');
                if (updateIndicator) {
                    updateIndicator.style.display = 'none';
                }
            }

            atualizarIndicadorCache() {
                if (!this.filialAtual) {
                    this.ocultarIndicadorCache();
                    return;
                }
                
                const cacheInfo = filterManager.getCacheInfo(this.filialAtual);
                const cacheIndicator = document.getElementById('cacheIndicator');
                const nextUpdateTime = document.getElementById('nextUpdateTime');
                
                if (cacheInfo.hasCache && cacheInfo.timeUntilExpiry > 0) {
                    const updateTime = new Date(Date.now() + cacheInfo.timeUntilExpiry);
                    const horas = updateTime.getHours().toString().padStart(2, '0');
                    const minutos = updateTime.getMinutes().toString().padStart(2, '0');
                    
                    nextUpdateTime.textContent = `${horas}:${minutos}`;
                    cacheIndicator.style.display = 'flex';
                } else {
                    this.ocultarIndicadorCache();
                }
            }

            ocultarIndicadorCache() {
                const cacheIndicator = document.getElementById('cacheIndicator');
                cacheIndicator.style.display = 'none';
            }

            mostrarNotificacaoCache() {
                // Implementar notificação visual de cache se necessário
                console.log('Dados carregados do cache local');
            }

            mostrarNotificacaoSucesso(mensagem) {
                // Criar notificação temporária
                const notification = document.createElement('div');
                notification.className = 'error-alert';
                notification.style.background = '#d1fae5';
                notification.style.borderColor = '#10b981';
                notification.style.color = '#065f46';
                notification.style.position = 'fixed';
                notification.style.top = '20px';
                notification.style.right = '20px';
                notification.style.zIndex = '9999';
                notification.innerHTML = `<i class="fas fa-check-circle"></i> ${mensagem}`;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            pararAutoRefresh() {
                if (this.cacheUpdateInterval) {
                    clearInterval(this.cacheUpdateInterval);
                    this.cacheUpdateInterval = null;
                }
                this.ocultarIndicadorCache();
            }

            exportarCSV(dados, tipo) {
                if (!dados || dados.length === 0) {
                    this.mostrarErro('Não há dados para exportar');
                    return;
                }

                let headers, rows;
                
                if (tipo === 'expedicao') {
                    headers = ['Filial', 'PEDIDOS', 'CLIENTE', 'CIDADE', 'UF', 'PALETES', 'NOTA FISCAL', 
                               'DATA EMPENHO', 'DATA OC ENVIADA', 'CHEGADA TRANSPORTADORA', 
                               'DATA CARREGAMENTO', 'TEMPO_SEPARACAO', 'TEMPO_CARREGAMENTO', 
                               'TRANSPORTADORA', 'TIPO CARREGAMENTO', 'HORA PROGRAMADA',
                               'LEAD_TIME', 'TIPO ATRASO', 'HOUVE ERRO?', 'TIPO DE ERRO'];
                    rows = dados.map(item => [
                        item.FILIAL || '',
                        item.PEDIDOS || '',
                        item.CLIENTE || '',
                        item.CIDADE || '',
                        item.UF || '',
                        item.PALETES_FORMATADO || '0,00',
                        item['NOTA FISCAL'] || '',
                        item.DATA_EMPENHO_FORMATADA || '',
                        item.DATA_OC_ENVIADA_FORMATADA || '',
                        item.DATA_CHEGADA_TRANSP_FORMATADA || '',
                        item.DATA_CARREG_FORMATADA || '',
                        item.TEMPO_SEPARACAO_FORMATADO || '0h 00min',
                        item.TEMPO_CARREGAMENTO_FORMATADO || '0h 00min',
                        item.TRANSPORTADORA || '',
                        item.TIPO_CARREGAMENTO || '', // NOVA COLUNA
                        item.HORA_PROGRAMADA || '',
                        item.LEAD_TIME_FORMATADO || '0h 00min',
                        item.TIPO_ATRASO || 'INDEFINIDO',
                        item.TEM_ERRO ? 'Sim' : 'Não',
                        item.ERRO_DETALHE || ''
                    ]);
                } else if (tipo === 'recebimento') {
                    headers = ['Filial', 'NF', 'CLIENTE/FILIAL', 'TRANSPORTADORA', 'DATA DE RECEBIMENTO', 'DATA LANÇAMENTO', 'ARMAZEM', 'HOUVE ERRO?', 'QUAL ERRO?'];
                    rows = dados.map(item => [
                        item.FILIAL || '',
                        item.NF || '',
                        item['CLIENTE/FILIAL'] || '',
                        item.TRANSPORTADORA || '',
                        item.DATA_RECEBIMENTO_FORMATADA || '',
                        item.DATA_LANCAMENTO_FORMATADA || 'Pendente',
                        item.ARMAZEM || '',
                        item.TEM_ERRO ? 'Sim' : 'Não',
                        item['QUAL ERRO?'] || ''
                    ]);
                } else if (tipo === 'emandamento') {
                    headers = ['Filial', 'PEDIDOS', 'CLIENTE', 'CIDADE', 'UF', 'PALETES', 
                               'NOTA FISCAL', 'TRANSPORTADORA', 'TIPO CARREGAMENTO',
                               'STATUS SEPARAÇÃO', 'INICIO SEPARAÇÃO', 'FIM SEPARAÇÃO'];
                    rows = dados.map(item => [
                        item.FILIAL || '',
                        item.PEDIDOS || '',
                        item.CLIENTE || '',
                        item.CIDADE || '',
                        item.UF || '',
                        item.PALETES_FORMATADO || '0,00',
                        item['NOTA FISCAL'] || '',
                        item.TRANSPORTADORA || '',
                        item.TIPO_CARREGAMENTO || '', // NOVA COLUNA
                        item.STATUS_SEPARACAO || '',
                        item.SEPARACAO_INICIO || '',
                        item.SEPARACAO_FINAL || ''
                    ]);
                }
                
                let csvContent = headers.join(';') + '\n';
                rows.forEach(row => {
                    const escapedRow = row.map(cell => {
                        const cellStr = String(cell);
                        return cellStr.includes(';') ? `"${cellStr}"` : cellStr;
                    });
                    csvContent += escapedRow.join(';') + '\n';
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${tipo}_${Utils.formatarData(new Date(), 'br')}.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            mostrarLoading() {
                document.getElementById('loadingExpedicao').style.display = 'flex';
                document.getElementById('loadingRecebimento').style.display = 'flex';
                document.getElementById('loadingEmAndamento').style.display = 'flex';
                tableManager.ocultarTabelas();
                filterManager.ocultarResultados();
            }

            ocultarLoading() {
                document.getElementById('loadingExpedicao').style.display = 'none';
                document.getElementById('loadingRecebimento').style.display = 'none';
                document.getElementById('loadingEmAndamento').style.display = 'none';
            }

            mostrarErro(mensagem) {
                const errorDiv = document.getElementById('errorExpedicao');
                errorDiv.textContent = mensagem;
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            }

            mostrarErroExpedicao(mensagem) {
                const errorDiv = document.getElementById('errorExpedicao');
                document.getElementById('errorTextExpedicao').textContent = mensagem;
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            }

            mostrarErroRecebimento(mensagem) {
                const errorDiv = document.getElementById('errorRecebimento');
                document.getElementById('errorTextRecebimento').textContent = mensagem;
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            }

            mostrarErroEmAndamento(mensagem) {
                const errorDiv = document.getElementById('errorEmAndamento');
                document.getElementById('errorTextEmAndamento').textContent = mensagem;
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            }
        }

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboardApp = new DashboardApp();
            
            // Função de debug para verificar tipos de carregamento
            window.debugTipoCarregamentoDetalhado = function() {
                if (dashboardApp.dados.expedicao && dashboardApp.dados.expedicao.length > 0) {
                    console.log('=== DEBUG DETALHADO TIPO DE CARREGAMENTO ===');
                    
                    // Mostrar todos os tipos únicos encontrados
                    const tiposUnicos = {};
                    const tiposOriginais = {};
                    
                    dashboardApp.dados.expedicao.forEach((item, index) => {
                        const tipo = item.TIPO_CARREGAMENTO || 'N/A';
                        const tipoOriginal = item.TIPO_CARREGAMENTO_ORIGINAL || 'N/A';
                        
                        tiposUnicos[tipo] = (tiposUnicos[tipo] || 0) + 1;
                        tiposOriginais[tipoOriginal] = (tiposOriginais[tipoOriginal] || 0) + 1;
                        
                        // Mostrar primeiros 5 itens detalhadamente
                        if (index < 5) {
                            console.log(`Item ${index + 1}:`);
                            console.log('- Tipo processado:', tipo);
                            console.log('- Tipo original:', tipoOriginal);
                            console.log('- Todas as chaves:', Object.keys(item));
                            console.log('- Valor da coluna "TIPO DE CARREGAMENTO":', item['TIPO DE CARREGAMENTO']);
                        }
                    });
                    
                    console.log('\n=== ESTATÍSTICAS ===');
                    console.log('Tipos processados únicos:', tiposUnicos);
                    console.log('Tipos originais únicos:', tiposOriginais);
                    console.log('Total de registros:', dashboardApp.dados.expedicao.length);
                    
                    // Verificar também os filtros
                    console.log('\n=== FILTROS DISPONÍVEIS ===');
                    const filtroTipo = document.getElementById('tipoCarregamentoExpedicao');
                    if (filtroTipo) {
                        console.log('Opções no filtro de tipo de carregamento:', 
                            Array.from(filtroTipo.options).map(opt => opt.value));
                    }
                } else {
                    console.log('Nenhum dado disponível para debug');
                }
            };
        });
    </script>
</body>
</html>
